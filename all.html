<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  å°é©¬åŒå­¦çš„ç¢ç¢å¿µ
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="å°é©¬åŒå­¦çš„ç¢ç¢å¿µ" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
 
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site: ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="https://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; å°é©¬åŒå­¦çš„ç¢ç¢å¿µ</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
        
        <li><a target="self" href="index.html">Home</a></li>
        
        <li><a target="_self" href="archives.html">Archives</a></li>
        

    <li><label>Categories</label></li>

        
            <li><a href="iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html">iOS é¢è¯•å‡†å¤‡</a></li>
        
            <li><a href="iOS%20%E5%BC%80%E5%8F%91%E6%8A%80%E5%B7%A7%E6%95%B4%E7%90%86.html">iOS å¼€å‘æŠ€å·§æ•´ç†</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
	$(function(){
		$('#menu_item_index').addClass('is_active');
	});
</script>
<div class="row">
	<div class="large-8 medium-8 columns">
		<div class="markdown-body home-categories">
		
			<div class="article">
                <a class="clearlink" href="15824490308760.html">
                
                  <h1>å¯¹è±¡ä»åˆ›å»ºåˆ°é”€æ¯è¿‡ç¨‹çš„æ¢ç©¶</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p><strong>NSObject</strong><br/>
å…ˆçœ‹ä¸‹NSObjectçš„å†…å­˜ç»“æ„<br/>
<img src="media/15824490308760/15824492522698.jpg" alt="" style="width:590px;"/></p>

<p>å®ä¾‹å¯¹è±¡çš„ isa æŒ‡é’ˆæŒ‡å‘ class(ç±»å¯¹è±¡),æ ¹æ® runtimeæºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ° objc_class æ˜¯ç»§æ‰¿è‡ª objc_object çš„,æœ¬è´¨ä¸Š,ç±»æ˜¯ä¸€ä¸ªå¯¹è±¡,æ‰€ä»¥æˆ‘ä»¬æ‰ä¼šå¸¸è¯´<strong>&quot;ç±»å¯¹è±¡&quot;</strong><br/>
<strong>objc_object æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç§æœ‰å˜é‡-isa_t ç±»å‹çš„ isa</strong></p>

<p>objc_class çš„å®šä¹‰è¿˜åŒ…æ‹¬äº†:</p>

<ul>
<li>Class superclass -æŒ‡å‘çˆ¶ç±»</li>
<li>cathe_t cathe æ–¹æ³•ç¼“å­˜</li>
<li>class_data_bits_t bits -å­˜å‚¨ç±»æ–¹æ³•,å±æ€§,åè®®ç­‰æ•°æ®</li>
</ul>

<p><strong>isa_t isa</strong><br/>
isaåˆåŒ…æ‹¬å“ªäº›ä¸œè¥¿?</p>

<p>å‚è€ƒ:<br/>
<a href="https://juejin.im/entry/58a178060ce463005644ee4a">https://juejin.im/entry/58a178060ce463005644ee4a</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/02/23</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15823522930291.html">
                
                  <h1>å‡†å¤‡</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<ul>
<li>iOS æ·±æ‹·è´,æµ…æ‹·è´</li>
<li>äº‹ä»¶å“åº”é“¾-æ‰‹åŠ¿</li>
<li></li>
</ul>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/02/22</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15821054226825.html">
                
                  <h1>ç‰›é€¼çš„GCD</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p><strong>DispatchQueue</strong><br/>
è‹¹æœå®˜æ–¹å¯¹ GCD çš„è¯´æ˜:</p>

<blockquote>
<p>å¼€å‘è€…è¦åšçš„åªæ˜¯å®šä¹‰æƒ³æ‰§è¡Œçš„ä»»åŠ¡å¹¶è¿½åŠ åˆ°åˆé€‚çš„ Dispatch Queue ä¸­</p>
</blockquote>

<p>GCD ä¸­åŒ…å«ä¸¤ç§é˜Ÿåˆ—:<br/>
ä¸²è¡Œé˜Ÿåˆ— DISPATCH_QUEUE_SERIAL<br/>
<img src="media/15821054226825/15821156796654.jpg" alt="" style="width:566px;"/><br/>
ä¸²è¡Œé˜Ÿåˆ—ä¼šé˜»å¡å½“å‰çº¿ç¨‹çš„æ‰§è¡Œ,ç­‰ä»»åŠ¡å®Œæˆ,æ‰ä¼šè¿›è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡<br/>
<img src="media/15821054226825/15821157466982.jpg" alt="" style="width:397px;"/></p>

<p><img src="media/15821054226825/15821157625913.jpg" alt="" style="width:557px;"/></p>

<p>ä¾‹å¦‚:<br/>
<img src="media/15821054226825/15821164356253.jpg" alt="" style="width:629px;"/><br/>
queue ä¸ºä¸²è¡Œçš„æ—¶å€™,å› ä¸ºè¦ç­‰å¾…ç°åœ¨æ‰§è¡Œçš„å¤„ç†ç»“æŸ,æ‰€ä»¥è¡¨ç°å°±æ˜¯ä¾æ¬¡æ‰§è¡Œ,é¡ºåºå¤„ç†.<br/>
å½“ queue ä¸ºDISPATCH_QUEUE_CONCURRENTæ—¶,å› ä¸ºä¸éœ€è¦ç­‰å¾…å½“å‰æ‰§è¡Œçš„å¤„ç†ç»“æŸ,å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ª,ä¸ç®¡ç¬¬ä¸€ä¸ªæ˜¯å¦æ‰§è¡Œå®Œæ¯•,éƒ½å¼€å§‹å¾€ä¸‹æ‰§è¡Œ,å¹¶ä¸”é¡ºåºä¸æ˜¯å›ºå®šçš„<br/>
<img src="media/15821054226825/15821166554297.jpg" alt="" style="width:662px;"/><br/>
<img src="media/15821054226825/15821166798014.jpg" alt="" style="width:563px;"/></p>

<p><strong>é˜Ÿåˆ—çš„åˆ›å»º</strong></p>

<ol>
<li>é€šè¿‡dispatch_queue_createå‡½æ•°åˆ›å»º</li>
<li>ç›´æ¥è¿‡å»ç³»ç»Ÿåˆ›å»ºå¥½çš„ MainQueue / GlobalQueue</li>
</ol>

<p><strong>dispatch_after</strong><br/>
dispatch_afterå‡½æ•°å¹¶ä¸æ˜¯åœ¨æŒ‡å®šæ—¶é—´ä»¥åæ‰§è¡Œ,è€Œæ˜¯<strong>åœ¨æŒ‡å®šæ—¶é—´åè¿½åŠ å¤„ç†åˆ° dispatch queue</strong><br/>
<img src="media/15821054226825/15821176029539.jpg" alt="" style="width:610px;"/></p>

<p><strong>dispatch_group</strong><br/>
æœ‰æ—¶å€™éœ€è¦åœ¨æŸå‡ ä¸ªä»»åŠ¡ç»“æŸä¹‹å,å†è¿›è¡Œæ–°çš„ä»»åŠ¡,ä¾‹å¦‚:<br/>
<img src="media/15821054226825/15821182215704.jpg" alt="" style="width:553px;"/><br/>
<img src="media/15821054226825/15821183629319.jpg" alt="" style="width:633px;"/><br/>
<img src="media/15821054226825/15821184229942.jpg" alt="" style="width:622px;"/><br/>
<img src="media/15821054226825/15821184582389.jpg" alt="" style="width:547px;"/></p>

<p><strong>dispatch_barrier_async(æ …æ å‡½æ•°)</strong></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/02/19</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15820370480952.html">
                
                  <h1>ç±» å­ç±» åˆ†ç±» åŒºåˆ«ä¸è”ç³»</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p><strong>åˆ†ç±»(category)</strong><br/>
åˆ†ç±»å…è®¸å¼€å‘è€…åœ¨ä¸æ”¹å˜åŸæœ‰ç±»çš„æƒ…å†µä¸‹,å¯¹è¯¥ç±»è¿›è¡Œæ‹“å±•,åˆ†ç±»æ˜¯ OC çš„ç‰¹æœ‰è¯­æ³•,ä»–æ˜¯è¡¨ç¤ºä¸€ä¸ªæŒ‡å‘åˆ†ç±»çš„ç»“æ„ä½“æŒ‡é’ˆ,åŸåˆ™ä¸Šåˆ†ç±»åªèƒ½å¢åŠ æ–¹æ³•,ä¸èƒ½å¢åŠ å®ä¾‹å˜é‡,å› ä¸ºåœ¨åˆ†ç±»ä¸­,ç±»çš„å®ä¾‹å˜é‡å¸ƒå±€å·²ç»å›ºå®š,æ‰€ä»¥ä¸èƒ½æ·»åŠ å®ä¾‹å˜é‡,ä½†æ˜¯å¯ä»¥åˆ©ç”¨ runtime çš„ç‰¹æ€§,æ·»åŠ å…³è”å±æ€§.</p>

<pre class="line-numbers"><code class="language-text">Category
Category æ˜¯è¡¨ç¤ºä¸€ä¸ªæŒ‡å‘åˆ†ç±»çš„ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š
typedef struct objc_category *Category;
struct objc_category {
  char *category_name                          OBJC2_UNAVAILABLE; // åˆ†ç±»å
  char *class_name                             OBJC2_UNAVAILABLE; // åˆ†ç±»æ‰€å±çš„ç±»å
  struct objc_method_list *instance_methods    OBJC2_UNAVAILABLE; // å®ä¾‹æ–¹æ³•åˆ—è¡¨
  struct objc_method_list *class_methods       OBJC2_UNAVAILABLE; // ç±»æ–¹æ³•åˆ—è¡¨
  struct objc_protocol_list *protocols         OBJC2_UNAVAILABLE; // åˆ†ç±»æ‰€å®ç°çš„åè®®åˆ—è¡¨
}
</code></pre>

<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡º,è¿™ä¸ªç»“æ„ä½“ä¸»è¦åŒ…å«äº†åˆ†ç±»å®šä¹‰çš„å®ä¾‹æ–¹æ³•ä¸ç±»æ–¹æ³•,ä½†æ˜¯è¿™é‡Œé¢å¹¶æ²¡æœ‰å±æ€§åˆ—è¡¨,ä¹Ÿå°±æ²¡åŠæ³•ç›´æ¥æ·»åŠ å±æ€§(å®ä¾‹å˜é‡)<br/>
<strong>è¦ç‚¹</strong>:</p>

<ul>
<li>åˆ†ç±»æ˜¯ç”¨äºç»™åŸæœ‰ç±»æ·»åŠ æ–¹æ³•çš„,å› ä¸ºåœ¨åˆ†ç±»çš„ç»“æ„ä½“ä¸­åªæœ‰æ–¹æ³•åˆ—è¡¨,æ²¡æœ‰å±æ€§åˆ—è¡¨.</li>
<li>åˆ†ç±»ä¸­å¯ä»¥å†™@property,ä½†æ˜¯ä¸ä¼šç”Ÿæˆ getter/setter æ–¹æ³•,ä¹Ÿä¸ä¼šç”Ÿæˆå®ä¾‹å˜é‡.ç¼–è¯‘å™¨ä¼šæœ‰è­¦å‘Š,ä½†æ˜¯ä¸ä¼šæŠ¥é”™</li>
<li>å¯ä»¥åœ¨åˆ†ç±»ä¸­è®¿é—®åŸæœ‰ç±»çš„.h ä¸­çš„å±æ€§</li>
<li><strong>å¦‚æœåˆ†ç±»ä¸­æœ‰å’ŒåŸæœ‰ç±»åŒåçš„æ–¹æ³•,ä¼šä¼˜å…ˆè°ƒç”¨åˆ†ç±»ä¸­çš„æ–¹æ³•,ä¹Ÿå°±æ˜¯ä¼šå¿½ç•¥åŸæœ‰ç±»çš„æ–¹æ³•,åŒåæ–¹æ³•ä¼˜å…ˆçº§&quot;åˆ†ç±»&gt;ç±»&gt;çˆ¶ç±»&quot;,æ‰€ä»¥åˆ†ç±»ä¸­ä¸è¦å’Œç±»ä¸­åŸæœ‰æ–¹æ³•åŒå</strong></li>
<li>å¦‚æœå¤šä¸ªåˆ†ç±»ä¸­éƒ½æœ‰å’Œå…ƒç±»åŒåçš„æ–¹æ³•,é‚£ä¹ˆè°ƒç”¨è¯¥æ–¹æ³•çš„æ—¶å€™,ç”±ç¼–è¯‘å™¨å†³å®š,ç¼–è¯‘å™¨ä¼šæ‰§è¡Œæœ€åä¸€ä¸ªå‚ä¸ç¼–è¯‘çš„åˆ†ç±»ä¸­çš„æ–¹æ³•.</li>
</ul>

<p><strong>æ‹“å±•</strong><br/>
<strong>ä¸»ç±»,å­ç±»,åˆ†ç±»ä¸­+loadæ–¹æ³•çš„æ‰§è¡Œé¡ºåº</strong></p>

<ul>
<li>+load æ–¹æ³•æ˜¯åœ¨ mian å‡½æ•°æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„,å¹¶ä¸ä¼šä¸»åŠ¨è°ƒç”¨</li>
<li>ä¸»ç±»,åˆ†ç±»,å­ç±»éƒ½ä¼šè°ƒç”¨+load æ–¹æ³•</li>
<li>è°ƒç”¨é¡ºåº:ä¸»ç±»çš„+loadæ–¹æ³•ä¼šå…ˆè°ƒç”¨,ç„¶åè°ƒç”¨å­ç±»çš„+load,æœ€åè°ƒç”¨åˆ†ç±»çš„+load.</li>
<li>æ‰€æœ‰åˆ†ç±»çš„+loadæ–¹æ³•éƒ½ä¼šè°ƒç”¨,è°ƒç”¨é¡ºåºå–å†³äºå®ƒçš„ç¼–è¯‘é¡ºåº.</li>
</ul>

<p><strong>+ Initializeæ–¹æ³•çš„è°ƒç”¨é¡ºåº</strong></p>

<ul>
<li>+ Initializeåªæœ‰å½“çœŸæ­£ç”¨åˆ°çš„æ—¶å€™,å¹¶ä¸”é‡å†™äº†+ Initializeæ–¹æ³•æ‰ä¼šè°ƒç”¨</li>
<li>å½“è°ƒç”¨å­ç±»çš„+ Initializeæ–¹æ³•çš„æ—¶å€™,å¦‚æœçˆ¶ç±»é‡å†™äº†+ Initializeæ–¹æ³•,ä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„+ Initialize,ç„¶åè°ƒç”¨å­ç±»çš„+ Initializeæ–¹æ³•,å¦‚æœæ­¤æ—¶çˆ¶ç±»çš„åˆ†ç±»ä¹Ÿé‡å†™äº†+ Initializeæ–¹æ³•,é‚£ä¹ˆçˆ¶ç±»çš„+ Initializeæ–¹æ³•å°±ä¼šè¢«è¦†ç›–æ‰</li>
</ul>

<p>å‚è€ƒ:<br/>
<a href="https://juejin.im/post/5b6a63f4e51d4534b93f770f">https://juejin.im/post/5b6a63f4e51d4534b93f770f</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/02/18</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15820364056941.html">
                
                  <h1>å…³è”å¯¹è±¡ AssociatedObject å®Œå…¨è§£æ</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>ç›¸å…³é¢è¯•é¢˜:</p>

<blockquote>
<p>å…³è”å¯¹è±¡æœ‰ä»€ä¹ˆåº”ç”¨ï¼Œç³»ç»Ÿå¦‚ä½•ç®¡ç†å…³è”å¯¹è±¡ï¼Ÿå…¶è¢«é‡Šæ”¾çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨å°†æ‰€æœ‰çš„å…³è”å¯¹è±¡çš„æŒ‡é’ˆç½®ç©ºä¹ˆï¼Ÿ</p>
</blockquote>

<p>å…ˆå›ç­”é—®é¢˜:</p>

<ol>
<li>å…³è”å¯¹è±¡çš„ä½œç”¨æ˜¯å¯ä»¥ä¸ºåˆ†ç±»<mark>å¢åŠ å®ä¾‹å˜é‡å’Œå­˜å–å‘æ³•</mark>(åˆ†ç±»ä¸èƒ½ç›´æ¥æ·»åŠ )</li>
<li>ç³»ç»Ÿä½¿ç”¨AssociationsManagerç®¡ç†å…³è”å¯¹è±¡</li>
</ol>

<p><strong>åœ¨åˆ†ç±»ä¸­,å› ä¸ºç±»çš„å®ä¾‹å˜é‡å¸ƒå±€å·²ç»å›ºå®š</strong>,ä½¿ç”¨@property å·²ç»æ— æ³•å‘å›ºå®šçš„å¸ƒå±€ä¸­æ·»åŠ æ–°çš„å®ä¾‹å˜é‡(è¿™æ ·åšå¯èƒ½ä¼šè¦†ç›–ä¹‹ç±»çš„å®ä¾‹å˜é‡),æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨å…³è”å¯¹è±¡ä»¥åŠä¸¤ä¸ªæ–¹æ³•æ¥æ¨¡æ‹Ÿæ„æˆå±æ€§çš„ä¸‰ä¸ªè¦ç´ .</p>

<p>åœ¨åˆ†ç±»ä¸­@property å¹¶ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆå®ä¾‹å˜é‡ä»¥åŠå­˜å–æ–¹æ³•,æ‰€ä»¥éœ€è¦ä½¿ç”¨å…³è”å¯¹è±¡ä¸ºå·²ç»å­˜åœ¨çš„ç±»æ·»åŠ å±æ€§,ä¾‹å¦‚:</p>

<pre class="line-numbers"><code class="language-text">#import &quot;DKObject+Category.h&quot;
#import &lt;objc/runtime.h&gt;

@implementation DKObject (Category)

- (NSString *)categoryProperty {
    return objc_getAssociatedObject(self, _cmd);
}

- (void)setCategoryProperty:(NSString *)categoryProperty {
    objc_setAssociatedObject(self, @selector(categoryProperty), categoryProperty, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
@end
</code></pre>

<p>æˆ‘ä»¬ä½¿ç”¨äº† <mark>objc_getAssociateedObjcet</mark>ä»¥åŠ <mark>objc_serAssociatedObject</mark> æ¥æ¨¡æ‹Ÿå±æ€§çš„å­˜å–æ–¹æ³•,ä½¿ç”¨å…³è”å¯¹è±¡æ¥æ¨¡æ‹Ÿå®ä¾‹å˜é‡</p>

<p>è¿™é‡Œæœ‰ä¸¤ä¸ªéœ€è¦è§£é‡Šçš„é—®é¢˜:</p>

<ol>
<li>ä¸ºä»€ä¹ˆå‘æ–¹æ³•ä¸­ä¼ å…¥@selector(catagoryProperty)?</li>
<li>OBJC_ASSOCIATION_RETAIN_NONATOMICæ˜¯å¹²ä»€ä¹ˆçš„</li>
</ol>

<p>å…³äºç¬¬ä¸€ä¸ª,æˆ‘ä»¬å…ˆçœ‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„åŸå‹;</p>

<pre class="line-numbers"><code class="language-text">id objc_getAssociatedObject(id object, const void *key);
void objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy);
</code></pre>

<p>@selector(categoryProperty)å…¶å®ä¹Ÿå°±æ˜¯å‚æ•°ä¸­çš„ key,å…¶å®å¯ä»¥ä½¿ç”¨é™æ€æŒ‡é’ˆ stati void * ç±»å‹çš„å‚æ•°æ¥ä»£æ›¿,ä¸è¿‡è¿™é‡Œå¼ºçƒˆå»ºè®®ä½¿ç”¨@selector(categoryProperty)ä½œä¸ºkey ä¼ å…¥.å› ä¸ºè¿™ç§æ–¹æ³•çœç•¥äº†ç”Ÿå‘½å‚æ•°çš„ä»£ç ,å¹¶ä¸”èƒ½å¾ˆå¥½çš„ä¿è¯ key çš„å”¯ä¸€æ€§.<br/>
å…³äºOBJC_ASSOCIATION_RETAIN_NONATOMIC,å…¶å®å°±æ˜¯å†…å­˜ç®¡ç†è¯­å¥.<br/>
<img src="media/15820364056941/15820966989089.jpg" alt="" style="width:519px;"/><br/>
æ³¨æ„:å…³è”å¯¹è±¡çš„å†…å­˜ç®¡ç†ç­–ç•¥ä¸­æ²¡æœ‰å¯¹åº”çš„ weak.å¦‚æœç¡®å®éœ€è¦ä½¿ç”¨ weak åº”è¯¥æ€ä¹ˆå¤„ç†å‘¢?<br/>
æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ block åŒ…èµ·æ¥,ä¾‹å¦‚:</p>

<pre class="line-numbers"><code class="language-text">-(void)setWeakvalue:(NSObject *)weakvalue {
    __weak typeof(weakvalue) weakObj = weakvalue;
    typeof(weakvalue) (^block)() = ^(){
        return weakObj;
    };
    objc_setAssociatedObject(self, weakValueKey, block, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
-(NSObject *)weakvalue {
    id (^block)() = objc_getAssociatedObject(self, weakValueKey);
    return block();
}
</code></pre>

<p>é¦–å…ˆæˆ‘ä»¬åœ¨ setter æ–¹æ³•é‡Œé¢ä½¿ç”¨äº†ä¸€ä¸ªweak çš„å±€éƒ¨å˜é‡ weakObj æ¥å­˜å‚¨å€¼,å¹¶åœ¨ block ä¸­å°†å…¶æ•è·å¹¶è¿”å›,ç”±äº weakObj æ˜¯å¼±å¼•ç”¨,æ‰€ä»¥ä¸ä¼šä¿®æ”¹å¯¹è±¡çš„å¼•ç”¨è®¡æ•°,å½“å¯¹è±¡é‡Šæ”¾æ—¶,ç”±äº weakObj çš„ weak å±æ€§,å®ƒåœ¨é‡Šæ”¾åä¹Ÿä¼šæŒ‡å‘ nil,æ‰€ä»¥åœ¨ getter è¿”å›çš„æ—¶å€™ä¹Ÿå°±æ˜¯ nil,ä¹Ÿå°±æ˜¯æ¨¡æ‹Ÿäº† weak é‡Šæ”¾åè‡ªåŠ¨ç½®ä¸º nil.</p>

<p><strong>objc_setAssociatedObject</strong></p>

<pre class="line-numbers"><code class="language-text">void _object_set_associative_reference(id object, void *key, id value, uintptr_t policy) {
    // å…³è”å¯¹è±¡ä½¿ç”¨ ObjcAssociation è¿™ä¸ªc++å¯¹è±¡æ¥å­˜å‚¨ã€‚
      // è®¾ç½®æ–°å¯¹è±¡ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½æœ‰è€çš„å¯¹è±¡ä¼šè¢«åºŸå¼ƒã€‚é‚£ä¹ˆæ–°å»ºä¸€ä¸ªObjcAssociationå¯¹è±¡ï¼Œä¹‹åç”¨æ¥å­˜å‚¨è€çš„å¯¹è±¡
    ObjcAssociation old_association(0, nil);

      // acquireValueå‡½æ•°ï¼š è®¾ç½®æ–°çš„å¯¹è±¡çš„retainCountï¼Œä¹Ÿå°±æ˜¯å¯¹ä»–è¿›è¡Œæ‰‹åŠ¨å†…å­˜ç®¡ç†
    id new_value = value ? acquireValue(value, policy) : nil;
    {
        AssociationsManager manager;
        AssociationsHashMap &amp;associations(manager.associations());
        disguised_ptr_t disguised_object = DISGUISE(object);

          // å¦‚æœç¡®å®æ˜¯è¦è®¾ç½®æ–°å…³è”å¯¹è±¡çš„æ—¶å€™
        if (new_value) {
            // break any existing association.
            AssociationsHashMap::iterator i = associations.find(disguised_object);

              // è¿™ä¸ªå¯¹è±¡ä¹‹å‰è®¾ç½®è¿‡å…³è”å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥å¯¹è±¡çš„å…³è”å¯¹è±¡æ•°é‡å¤§äº1
            if (i != associations.end()) {
                // secondary table exists
                ObjectAssociationMap *refs = i-&gt;second;
                ObjectAssociationMap::iterator j = refs-&gt;find(key);
                 // å¯»æ‰¾å…¨å±€çš„å…³è”å¯¹è±¡è¡¨ï¼Œå¦‚æœå­˜åœ¨è€å¯¹è±¡çš„è¯
                if (j != refs-&gt;end()) {
                      // å­˜å‚¨è€å¯¹è±¡åˆ°ä¹‹å‰æ–°å»ºçš„ObjcAssociationå¯¹è±¡ä¸­
                    old_association = j-&gt;second;
                      // è®¾ç½®æ–°çš„å…³è”å¯¹è±¡
                    j-&gt;second = ObjcAssociation(policy, new_value);
                }
                  // ä¸å­˜åœ¨è€å¯¹è±¡ï¼Œç›´æ¥è®¾ç½®æ–°å…³è”å¯¹è±¡
                  else {
                    (*refs)[key] = ObjcAssociation(policy, new_value);
                }
            }
              // è¿™ä¸ªå¯¹è±¡ä¹‹å‰æ²¡æœ‰è®¾ç½®è¿‡ä»»ä½•çš„å…³è”å¯¹è±¡
              else {
                // create the new association (first time).
                ObjectAssociationMap *refs = new ObjectAssociationMap;
                associations[disguised_object] = refs;
                (*refs)[key] = ObjcAssociation(policy, new_value);
                 // å°†å¯¹è±¡çš„isaçš„has_assocå­—æ®µè®¾ç½®æˆtrue
                object-&gt;setHasAssociatedObjects();
            }
        } 
          // è¦å°†å…³è”å¯¹è±¡è®¾æˆ nilï¼Œä¹Ÿå°±æ˜¯å–æ¶ˆè¯¥å…³è”å¯¹è±¡ã€‚å…ˆå­˜è€å¯¹è±¡ï¼Œå†åœ¨å…¨å±€è¡¨ä¸­åˆ é™¤è¯¥å…³è”å¯¹è±¡
          else {
            // setting the association to nil breaks the association.
            AssociationsHashMap::iterator i = associations.find(disguised_object);
            if (i !=  associations.end()) {
                ObjectAssociationMap *refs = i-&gt;second;
                ObjectAssociationMap::iterator j = refs-&gt;find(key);
                if (j != refs-&gt;end()) {
                    old_association = j-&gt;second;
                    refs-&gt;erase(j);
                }
            }
        }
    }
    // é‡Šæ”¾è€å¯¹è±¡ï¼ŒretainCountç›¸å…³ï¼Œå†…å­˜ç®¡ç†ç›¸å…³
    if (old_association.hasValue()) ReleaseValue()(old_association);
}
</code></pre>

<p>å¯ä»¥çœ‹åˆ°è®¾ç½®æ–°çš„å…³è”å¯¹è±¡å…¶å®å¾ˆç®€å•ï¼š</p>

<ul>
<li>ç°åœ¨å…¨å±€å…³è”å¯¹è±¡è¡¨ä¸­å¯»æ‰¾è¿™ä¸ª key</li>
<li>å…ˆå­˜åŸæ¥å…³è”å¯¹è±¡</li>
<li>å†è®¾ç½®æ–°çš„å…³è”å¯¹è±¡</li>
<li>é‡Šæ”¾åŸæœ‰çš„å…³è”å¯¹è±¡</li>
</ul>

<p><strong>å…³è”å¯¹è±¡çš„å®ç°</strong><br/>
å…³è”å¯¹è±¡ä½¿ç”¨çš„æ˜¯å…¨å±€çš„è¡¨æ¥å­˜å‚¨æ‰€æœ‰å…³è”å¯¹è±¡,å¦‚å›¾:<br/>
<img src="media/15820364056941/15820977012071.jpg" alt="" style="width:643px;"/><br/>
<strong>å…³è”å¯¹è±¡æ˜¯å’Œå¯¹è±¡ä¸€ä¸€å¯¹åº”çš„,è€Œä¸æ˜¯å’Œç±»ä¸€ä¸€å¯¹åº”çš„</strong></p>

<ol>
<li>æ‰€æœ‰çš„å…³è”å¯¹è±¡éƒ½ç”±ä¸€ä¸ª<strong>AssociationsManager</strong>å¯¹è±¡æ¥ç®¡ç†,è¿™ä¸ªå¯¹è±¡é‡Œæœ‰ä¸€ä¸ª<strong>AssociationsHashMap</strong>.</li>
<li><strong>AssociationsHashMap</strong>ç”±è®¸å¤š key-value æ„æˆ.key æ˜¯å¯¹è±¡çš„åœ°å€,value æ˜¯ä¸€ä¸ª<strong>ObjectAssociationMap</strong>,ä¹Ÿå°±æ˜¯æ‰€è°“çš„å…³è”å¯¹è±¡</li>
<li><strong>ObjectAssociationMap</strong>å°±æ˜¯å…³è”å¯¹è±¡,æ¯ä¸ªå…³è”å¯¹è±¡é‡Œé¢åŒ…å«å¤šä¸ª key-value å¯¹,key æ˜¯å±æ€§å,value æ˜¯<strong>ObjcAssociation</strong>,ä¹Ÿå°±æ˜¯ç›¸å½“äºå±æ€§å¯¹åº”çš„å®ä¾‹å˜é‡.</li>
<li><strong>ObjcAssociation</strong>ç›¸å½“äºå®ä¾‹å˜é‡,è¿™ä¸ªç»“æ„ä½“æœ‰ä¸¤ä¸ªæˆå‘˜,_policy å±æ€§çš„å†…å­˜ç®¡ç†è¯­å¥,_value å±æ€§çš„å€¼</li>
</ol>

<p>æ€»ç»“:</p>

<ol>
<li>category å¯ä»¥ç»™ç°æœ‰ç±»æ·»åŠ å±æ€§,æ–¹æ³•,åè®®,ä½†æ˜¯ä¸èƒ½æ·»åŠ å®ä¾‹å˜é‡</li>
<li>æ·»åŠ å±æ€§å¯¹åº”çš„å®ä¾‹å˜é‡éœ€è¦ä½¿ç”¨å…³è”å¯¹è±¡æ¥å®ç°</li>
<li>category é‡Œé¢çš„æ–¹æ³•ä¸ä¼šè¦†ç›–æ‰åŸæœ‰åŒåæ–¹æ³•,åªæ˜¯ä¼šæå‰æ£€ç´¢åˆ°,æ‰€ä»¥æ„Ÿè§‰æ˜¯è¢«è¦†ç›–æ‰äº†</li>
<li>å¯¹äºç³»ç»Ÿè‡ªå¸¦çš„ç±»,åœ¨ runtime æ—¶æ‰ä¼šåŠ è½½ category,ä½†æ˜¯è‡ªå®šä¹‰çš„åˆ†ç±»åœ¨ç¼–è¯‘æœŸå°±å·²ç»å…¨éƒ¨åŠ è½½äº†,å°±åƒä¸å­˜åœ¨åˆ†ç±»,ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªå¤§å¤§çš„è‡ªå®šä¹‰ç±»ä¸€æ ·.</li>
</ol>

<p>å‚è€ƒ:<br/>
<a href="https://draveness.me/ao">https://draveness.me/ao</a><br/>
<a href="http://vanney9.com/2017/07/14/association-object-and-retain-count/">http://vanney9.com/2017/07/14/association-object-and-retain-count/</a><br/>
<a href="http://vanney9.com/2017/06/07/objective-c-runtime-category/">http://vanney9.com/2017/06/07/objective-c-runtime-category/</a><br/>
<a href="https://www.jianshu.com/p/1b0a1f9ecf39">https://www.jianshu.com/p/1b0a1f9ecf39</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/02/18</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15820198947096.html">
                
                  <h1>weak çš„é‡Šæ”¾åŠåŸç†</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>1.è¢«weakä¿®é¥°çš„å¯¹è±¡åœ¨è¢«é‡Šæ”¾çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæ˜¯å¦‚ä½•å®ç°çš„ï¼ŸçŸ¥é“sideTableä¹ˆï¼Ÿé‡Œé¢çš„ç»“æ„å¯ä»¥ç”»å‡ºæ¥ä¹ˆ<br/>
åœ¨å›ç­”é—®é¢˜ä¹‹å‰,æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ weak çš„å†…éƒ¨ç»“æ„:</p>

<blockquote>
<p>æˆ‘ä»¬å¸¸è¯´çš„ weak,å…¶å®æ˜¯ runtime ç»´æŠ¤çš„ç”¨äºå­˜å‚¨å¯¹è±¡çš„æ‰€æœ‰ weak æŒ‡é’ˆçš„ hash è¡¨,<mark>key æ˜¯å¯¹è±¡çš„æŒ‡é’ˆ,value æ˜¯ weak æŒ‡é’ˆçš„åœ°å€(è¿™ä¸ªåœ°å€çš„å€¼æ˜¯æ‰€æŒ‡å¯¹è±¡çš„åœ°å€)æ•°ç»„</mark></p>
</blockquote>

<p>ä¾‹å¦‚:</p>

<pre class="line-numbers"><code class="language-text">NSObject *b = [NSObject new];
__weak id a = b;
</code></pre>

<p>è¿™é‡Œçš„ b å°±æ˜¯ weak è¡¨çš„ key,&amp;a(açš„å†…å­˜åœ°å€)å°±æ˜¯ value;</p>

<p><strong>weak çš„å®ç°åŸç†ç®€å•çš„æ¦‚æ‹¬å°±ä¸‰æ­¥:</strong></p>

<ol>
<li>åˆå§‹åŒ–æ—¶:runtime ä¼šè°ƒç”¨objc_initWeak å‡½æ•°,åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ weak æŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„åœ°å€</li>
<li>æ·»åŠ å¼•ç”¨æ—¶:objc_initWeak å‡½æ•°ä¼šè°ƒç”¨ objc_storeWeak()å‡½æ•°,objc_storeWeak()å‡½æ•°çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘,åˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨</li>
<li>é‡Šæ”¾æ—¶:è°ƒç”¨ clearDeallocating å‡½æ•°.clearDeallocatingå‡½æ•°é¦–å…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰ weak æŒ‡é’ˆåœ°å€çš„æ•°ç»„,ç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå…¶ä¸­çš„æ•°æ®ç½®ä¸º nil,æœ€åæŠŠè¿™ä¸ª entry ä» weak è¡¨ä¸­åˆ é™¤,æœ€åæ¸…ç†å¯¹è±¡çš„è®°å½•.</li>
</ol>

<p>åœ¨ runtime é‡Œ,weak ä¿®é¥°ç¬¦å˜é‡æ˜¯é€šè¿‡ objc_initWeak å‡½æ•°æ¥åˆå§‹åŒ–çš„,åœ¨å˜é‡ä½œç”¨åŸŸç»“æŸçš„æ—¶å€™é€šè¿‡ objc_destroyWeak å‡½æ•°æ¥é‡Šæ”¾çš„.</p>

<p>è¿™ä¸¤ä¸ªå‡½æ•°é•¿è¿™æ ·:</p>

<pre class="line-numbers"><code class="language-text">id objc_initWeak(id *location, id newObj)
{
    // æŸ¥çœ‹å¯¹è±¡å®ä¾‹æ˜¯å¦æœ‰æ•ˆ
    // æ— æ•ˆå¯¹è±¡ç›´æ¥å¯¼è‡´æŒ‡é’ˆé‡Šæ”¾
    if (!newObj) {
        *location = nil;
        return nil;
    }
    // è¿™é‡Œä¼ é€’äº†ä¸‰ä¸ª bool æ•°å€¼
    // ä½¿ç”¨ template è¿›è¡Œå¸¸é‡å‚æ•°ä¼ é€’æ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½
    return storeWeak&lt;false/*old*/, true/*new*/, true/*crash*/&gt;
        (location, (objc_object*)newObj);
}
</code></pre>

<pre class="line-numbers"><code class="language-text">void objc_destroyWeak(id *location)
{
    (void)storeWeak&lt;true/*old*/, false/*new*/, false/*crash*/&gt;
        (location, nil);
}
</code></pre>

<p>æ³¨æ„ç‚¹:</p>

<ol>
<li>objc_initWeak å‡½æ•°æœ‰ä¸€ä¸ªå‰ææ¡ä»¶,å°±æ˜¯ object å¿…é¡»æ˜¯ä¸€ä¸ªæ²¡æœ‰è¢«æ³¨å†Œä¸º weak å¯¹è±¡çš„æœ‰æ•ˆæŒ‡é’ˆ,è€Œ value åˆ™å¯ä»¥æ˜¯ null,æˆ–è€…æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„å¯¹è±¡</li>
<li>æ·»åŠ å¼•ç”¨æ—¶,object_initWeak å‡½æ•°ä¼šè°ƒç”¨ object_storeWeak()å‡½æ•°,object_storeWeak()å‡½æ•°çš„ä½œç”¨æ˜¯æ›´æ–°æŒ‡é’ˆæŒ‡å‘,åˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨</li>
</ol>

<p>ä»ä¸Šé¢ä¸¤ä¸ªä»£ç èƒ½çœ‹å‡ºæ¥ä»–ä»¬éƒ½è°ƒç”¨äº† storeWeak è¿™ä¸ªå‡½æ•°,ä½†æ˜¯ä¼ å…¥çš„å‚æ•°ç¡®æœ‰ç‚¹ä¸ä¸€æ ·<br/>
init æ–¹æ³•ä¸­,ç¬¬ä¸€ä¸ªå‚æ•°ä¸º weak çš„ä¿®é¥°å˜é‡,ç¬¬äºŒä¸ªå‚æ•°ä¸ºå¼•ç”¨è®¡æ•°å¯¹è±¡,ä½†æ˜¯åœ¨ destoryWeak å‡½æ•°,ç¬¬ä¸€å‚æ•°ä¾æ—§ä¸º weak ä¿®é¥°å˜é‡,ç¬¬äºŒä¸ªä¸º nil.å‚æ•°ä¸åŒåˆ°åº•ä»£è¡¨äº†ä»€ä¹ˆ?ä¸‹é¢ç»§ç»­åˆ†æ storeWeak è¿™ä¸ªå‡½æ•°:</p>

<pre class="line-numbers"><code class="language-text">// æ›´æ–°ä¸€ä¸ªå¼±å¼•ç”¨å˜é‡
// å¦‚æœ HaveOld æ˜¯ true, å˜é‡æ˜¯ä¸ªæœ‰æ•ˆå€¼ï¼Œéœ€è¦è¢«åŠæ—¶æ¸…ç†ã€‚å˜é‡å¯ä»¥ä¸º nilã€‚
// å¦‚æœ HaveNew æ˜¯ true, éœ€è¦ä¸€ä¸ªæ–°çš„ value æ¥æ›¿æ¢å˜é‡ã€‚å˜é‡å¯ä»¥ä¸º nil
// å¦‚æœcrashifdeallocation æ˜¯ ture ï¼Œé‚£ä¹ˆå¦‚æœ newObj æ˜¯ deallocatingï¼Œæˆ–è€… newObj çš„ç±»ä¸æ”¯æŒå¼±å¼•ç”¨ï¼Œåˆ™è¯¥è¿›ç¨‹å°±ä¼šåœæ­¢ã€‚
// å¦‚æœcrashifdeallocation æ˜¯ falseï¼Œé‚£ä¹ˆ nil ä¼šè¢«å­˜å‚¨ã€‚

template &lt;bool HaveOld, bool HaveNew, bool CrashIfDeallocating&gt;
static id storeWeak(id *location, objc_object *newObj)
{
    assert(HaveOld  ||  HaveNew);
    if (!HaveNew) assert(newObj == nil);

    Class previouslyInitializedClass = nil;
    id oldObj;
    
    // åˆ›å»ºæ–°æ—§æ•£åˆ—è¡¨
    SideTable *oldTable;
    SideTable *newTable;

    // Acquire locks for old and new values.
    // è·å¾—æ–°å€¼å’Œæ—§å€¼çš„é”å­˜ä½ç½® (ç”¨åœ°å€ä½œä¸ºå”¯ä¸€æ ‡ç¤º)
    // Order by lock address to prevent lock ordering problems.
    // é€šè¿‡åœ°å€æ¥å»ºç«‹ç´¢å¼•æ ‡å¿—ï¼Œé˜²æ­¢æ¡¶é‡å¤
    // Retry if the old value changes underneath us.
    // ä¸‹é¢æŒ‡å‘çš„æ“ä½œä¼šæ”¹å˜æ—§å€¼
 retry:
    if (HaveOld) {
    // å¦‚æœ HaveOld ä¸º true ï¼Œæ›´æ”¹æŒ‡é’ˆï¼Œè·å¾—ä»¥ oldObj ä¸ºç´¢å¼•æ‰€å­˜å‚¨çš„å€¼åœ°å€
        oldObj = *location;
        oldTable = &amp;SideTables()[oldObj];
    } else {
        oldTable = nil;
    }
    if (HaveNew) {
    // è·å¾—ä»¥ newObj ä¸ºç´¢å¼•æ‰€å­˜å‚¨çš„å€¼å¯¹è±¡
        newTable = &amp;SideTables()[newObj];
    } else {
        newTable = nil;
    }
    
// å¯¹ä¸¤ä¸ª table è¿›è¡ŒåŠ é”æ“ä½œï¼Œé˜²æ­¢å¤šçº¿ç¨‹ä¸­ç«äº‰å†²çª
    SideTable::lockTwo&lt;HaveOld, HaveNew&gt;(oldTable, newTable);

//  location åº”è¯¥ä¸ oldObj ä¿æŒä¸€è‡´ï¼Œå¦‚æœä¸åŒï¼Œè¯´æ˜å½“å‰çš„ location å·²ç»å¤„ç†è¿‡ oldObj å¯æ˜¯åˆè¢«å…¶ä»–çº¿ç¨‹æ‰€ä¿®æ”¹, ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè¿™ä¸ªåˆ¤æ–­ç”¨æ¥é¿å…çº¿ç¨‹å†²çªé‡å¤„ç†é—®é¢˜
    if (HaveOld  &amp;&amp;  *location != oldObj) {
        SideTable::unlockTwo&lt;HaveOld, HaveNew&gt;(oldTable, newTable);
        goto retry;
    }

    // Prevent a deadlock between the weak reference machinery
    // and the +initialize machinery by ensuring that no 
    // weakly-referenced object has an un-+initialized isa.
    // é˜²æ­¢å¼±å¼•ç”¨ä¹‹é—´å‘ç”Ÿæ­»é”ï¼Œå¹¶ä¸”é€šè¿‡ +initialize åˆå§‹åŒ–æ„é€ å™¨ä¿è¯æ‰€æœ‰å¼±å¼•ç”¨çš„ isa éç©ºæŒ‡å‘
    if (HaveNew  &amp;&amp;  newObj) {
        // è·å¾—æ–°å¯¹è±¡çš„ isa æŒ‡é’ˆ
        Class cls = newObj-&gt;getIsa();
        // åˆ¤æ–­ isa éç©ºä¸”å·²ç»åˆå§‹åŒ–
        if (cls != previouslyInitializedClass  &amp;&amp;  
            !((objc_class *)cls)-&gt;isInitialized()) 
        {
            // å¯¹ä¸¤ä¸ªè¡¨è§£é”
            SideTable::unlockTwo&lt;HaveOld, HaveNew&gt;(oldTable, newTable);
            _class_initialize(_class_getNonMetaClass(cls, (id)newObj));

            // If this class is finished with +initialize then we&#39;re good.
            // If this class is still running +initialize on this thread 
            // (i.e. +initialize called storeWeak on an instance of itself)
            // then we may proceed but it will appear initializing and 
            // not yet initialized to the check above.
            // Instead set previouslyInitializedClass to recognize it on retry.
            // å¦‚æœè¯¥ç±»å·²ç»å®Œæˆæ‰§è¡Œ +initialize æ–¹æ³•æ˜¯æœ€å¥½çš„ï¼Œå¦‚æœè¯¥ç±» + initialize åœ¨çº¿ç¨‹ä¸­ï¼Œä¾‹å¦‚ +initialize æ­£åœ¨è°ƒç”¨storeWeak æ–¹æ³•ï¼Œé‚£ä¹ˆåˆ™éœ€è¦æ‰‹åŠ¨å¯¹å…¶å¢åŠ ä¿æŠ¤ç­–ç•¥ï¼Œå¹¶è®¾ç½® previouslyInitializedClass æŒ‡é’ˆè¿›è¡Œæ ‡è®°ç„¶åé‡æ–°å°è¯•
            previouslyInitializedClass = cls;

            goto retry;
        }
    }

    // Clean up old value, if any. æ¸…é™¤æ—§å€¼
    if (HaveOld) {
        weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);
    }

    // Assign new value, if any. åˆ†é…æ–°å€¼
    if (HaveNew) {
        newObj = (objc_object *)weak_register_no_lock(&amp;newTable-&gt;weak_table, 
                                                      (id)newObj, location, 
                                                      CrashIfDeallocating);
        // weak_register_no_lock returns nil if weak store should be rejected
        // å¦‚æœå¼±å¼•ç”¨è¢«é‡Šæ”¾åˆ™è¯¥æ–¹æ³•è¿”å› nil
        // Set is-weakly-referenced bit in refcount table.
        // åœ¨å¼•ç”¨è®¡æ•°è¡¨ä¸­è®¾ç½®å¼±å¼•ç”¨æ ‡è®°ä½
        if (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) {
            newObj-&gt;setWeaklyReferenced_nolock();
        }

        // Do not set *location anywhere else. That would introduce a race.
        *location = (id)newObj;
    }
    else {
        // No new value. The storage is not changed.
    }
    
    SideTable::unlockTwo&lt;HaveOld, HaveNew&gt;(oldTable, newTable);

    return (id)newObj;
}
</code></pre>

<p>ä»¥ä¸Šå°±æ˜¯ storeWeak å‡½æ•°çš„å®ç°,ä»–åšäº†å‡ ä»¶äº‹:</p>

<ul>
<li>å£°æ˜äº†æ–°æ—§æ•£åˆ—è¡¨æŒ‡é’ˆ,å› ä¸º weak ä¿®é¥°çš„å˜é‡å¦‚æœä¹‹å‰å·²ç»æŒ‡å‘ä¸€ä¸ªå¯¹è±¡,ç„¶åå…¶å†æ¬¡æ”¹å˜æŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡,é‚£ä¹ˆæŒ‰ç†æ¥è¯´æˆ‘ä»¬éœ€è¦ä» oldTable åˆ é™¤ weak å˜é‡çš„è®°å½•,ä¹Ÿå°±æ˜¯è¦é‡Šæ”¾è¯¥ weak å˜é‡,ç„¶åå†ç»™ newTable æ·»åŠ æ–°è®°å½•(weakå˜é‡),è¿™é‡Œçš„æ–°æ—§æ•£åˆ—è¡¨å°±æ˜¯è¿™ä¸ªä½œç”¨</li>
<li>æ ¹æ®æ–°æ—§å˜é‡åœ°å€è·å–å“åº”çš„ SideTable</li>
<li>å¯¹ä¸¤ä¸ªè¡¨è¿›è¡ŒåŠ é”æ“ä½œ,é˜²æ­¢å¤šçº¿ç¨‹ç«äº‰å†²çª</li>
<li>è¿›è¡Œçº¿ç¨‹å†²çªé‡å¤„ç†åˆ¤æ–­</li>
<li>åˆ¤æ–­å…¶ isa æŒ‡é’ˆæ˜¯å¦ä¸ºç©º,ä¸ºç©ºåˆ™éœ€è¦åˆå§‹åŒ–</li>
<li>å¦‚æœå­˜åœ¨æ—§å€¼,è°ƒç”¨ weak_unregister_no_lock å‡½æ•°æ¸…æ¥šæ—§å€¼</li>
<li>è°ƒç”¨weak_register_no_lock å‡½æ•°åˆ†é…æ–°å€¼</li>
<li>è§£é”ä¸¤ä¸ªè¡¨,è¿”å›ç¬¬äºŒå‚æ•°</li>
</ul>

<p>tip:</p>

<blockquote>
<p>ä½ å¯ä»¥æŠŠobjc_storeWeak(id *location, objc_object *newObj)ç†è§£ä¸ºï¼šobjc_storeWeak(value, key)ï¼Œå¹¶ä¸”å½“keyå˜nilï¼Œå°†valueç½®nilã€‚<br/>
ç»“åˆæœ€å¼€å§‹çš„ä¾‹å­æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºobjc_storeWeak(&amp;a, b)<br/>
åœ¨bénilæ—¶ï¼Œaå’ŒbæŒ‡å‘åŒä¸€ä¸ªå†…å­˜åœ°å€ï¼Œåœ¨bå˜nilæ—¶ï¼Œaå˜nilã€‚æ­¤æ—¶å‘aå‘é€æ¶ˆæ¯ä¸ä¼šå´©æºƒï¼šåœ¨Objective-Cä¸­å‘nilå‘é€æ¶ˆæ¯æ˜¯å®‰å…¨çš„ã€‚<br/>
è€Œå¦‚æœaæ˜¯ç”± assign ä¿®é¥°çš„ï¼Œåˆ™ï¼š åœ¨ b é nil æ—¶ï¼Œa å’Œ b æŒ‡å‘åŒä¸€ä¸ªå†…å­˜åœ°å€ï¼Œåœ¨ b å˜ nil æ—¶ï¼Œa è¿˜æ˜¯æŒ‡å‘è¯¥å†…å­˜åœ°å€ï¼Œå˜é‡æŒ‡é’ˆã€‚æ­¤æ—¶å‘ a å‘é€æ¶ˆæ¯<mark>ææ˜“å´©æºƒ</mark>,ä¸æ˜¯ä¸€å®šä¼šå¥”æºƒ,æ¶‰åŠåˆ° assgin çš„é‡Šæ”¾é—®é¢˜ä¸‹é¢å†è¯´ã€‚</p>
</blockquote>

<p>åˆå§‹åŒ–å¼±å¼•ç”¨å¯¹è±¡æµç¨‹å›¾:<br/>
<img src="media/15820198947096/15820219239893.jpg" alt="" style="width:546px;"/></p>

<p><strong>æ•°æ®ç»“æ„åˆ†æ(* SideTablesã€RefcountMapã€weak_table_t*)</strong><br/>
<img src="media/15820198947096/15820337143051.jpg" alt="" style="width:601px;"/></p>

<p><strong>SideTable</strong></p>

<p>SideTableä¸»è¦ç”¨äºç®¡ç†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å’Œ weak è¡¨ä¸ºäº†ç®¡ç†æ‰€æœ‰å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å’Œ weak æŒ‡é’ˆ,è‹¹æœåˆ›å»ºäº†ä¸€ä¸ªå…¨å±€çš„ SideTables,æ˜¯ä¸€ä¸ªå…¨å±€çš„ Hash è¡¨,é‡Œé¢è£…çš„éƒ½æ˜¯ SideTableç»“æ„ä½“.ä»–ä½¿ç”¨å¯¹è±¡çš„å†…å­˜åœ°å€å½“ä»–çš„key.</p>

<pre class="line-numbers"><code class="language-text">struct SideTable {
// ä¿è¯åŸå­æ“ä½œçš„è‡ªæ—‹é”
    spinlock_t slock;
    // å¼•ç”¨è®¡æ•°çš„ hash è¡¨
    RefcountMap refcnts;
    // weak å¼•ç”¨å…¨å±€ hash è¡¨
    weak_table_t weak_table;
}
</code></pre>

<p><img src="media/15820198947096/15820337366643.jpg" alt="" style="width:469px;"/></p>

<p>ä»å£°æ˜ä¸­å¯ä»¥çœ‹å‡º,SideTableå†…éƒ¨åŒ…å«äº†ä¸€ä¸ªæ˜¯é˜²æ­¢å¤šçº¿ç¨‹ç«äº‰çš„è‡ªæ—‹é”(slock),ç¬¬äºŒä¸ªæ˜¯ååŠ©å¯¹è±¡çš„ isa æŒ‡é’ˆçš„ extra_rc å…±åŒå¼•ç”¨è®¡æ•°å˜é‡,è¿™é‡Œä¸»è¦çœ‹ weak_table_t çš„ç»“æ„å’Œä½œç”¨</p>

<p><strong>1,ä¸€æŠŠè‡ªæ—‹é”ã€‚spinlock_tâ€‚â€‚slock;</strong></p>

<blockquote>
<p>è‡ªæ—‹é”æ¯”è¾ƒé€‚ç”¨äºé”ä½¿ç”¨è€…ä¿æŒé”æ—¶é—´æ¯”è¾ƒçŸ­çš„æƒ…å†µã€‚æ­£æ˜¯ç”±äºè‡ªæ—‹é”ä½¿ç”¨è€…ä¸€èˆ¬ä¿æŒé”æ—¶é—´éå¸¸çŸ­ï¼Œå› æ­¤é€‰æ‹©è‡ªæ—‹è€Œä¸æ˜¯ç¡çœ æ˜¯éå¸¸å¿…è¦çš„ï¼Œè‡ªæ—‹é”çš„æ•ˆç‡è¿œé«˜äºäº’æ–¥é”ã€‚ä¿¡å·é‡å’Œè¯»å†™ä¿¡å·é‡é€‚åˆäºä¿æŒæ—¶é—´è¾ƒé•¿çš„æƒ…å†µï¼Œå®ƒä»¬ä¼šå¯¼è‡´è°ƒç”¨è€…ç¡çœ ï¼Œå› æ­¤åªèƒ½åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä½¿ç”¨ï¼Œè€Œè‡ªæ—‹é”é€‚åˆäºä¿æŒæ—¶é—´éå¸¸çŸ­çš„æƒ…å†µï¼Œå®ƒå¯ä»¥åœ¨ä»»ä½•ä¸Šä¸‹æ–‡ä½¿ç”¨ã€‚</p>
</blockquote>

<p><strong>2,å¼•ç”¨è®¡æ•°å™¨ RefcountMapâ€‚â€‚refcnts;</strong><br/>
å¯¹è±¡çš„å…·ä½“å¼•ç”¨è®¡æ•°æ•°é‡æ˜¯è®°å½•åœ¨è¿™é‡Œçš„<br/>
è¿™é‡Œçš„RefcountMapå…¶å®æ˜¯ä¸ª C++çš„ Map.<br/>
<img src="media/15820198947096/15820340809229.jpg" alt="" style="width:571px;"/></p>

<p><strong>weak_table_t</strong><br/>
weak_table_tç»“æ„ä½“å­˜å‚¨äº†æŸä¸ªå¯¹è±¡ç›¸å…³çš„æ‰€æœ‰å¼±å¼•ç”¨ä¿¡æ¯</p>

<pre class="line-numbers"><code class="language-text">/**
 * The global weak references table. Stores object ids as keys,
 * and weak_entry_t structs as their values.
 */
struct weak_table_t {
    // ä¿å­˜äº†æ‰€æœ‰æŒ‡å‘æŒ‡å®šå¯¹è±¡çš„ weak æŒ‡é’ˆ
    weak_entry_t *weak_entries;
    // å­˜å‚¨ç©ºé—´
    size_t    num_entries;
    // å‚ä¸åˆ¤æ–­å¼•ç”¨è®¡æ•°è¾…åŠ©é‡
    uintptr_t mask;
    // hash key æœ€å¤§åç§»å€¼
    uintptr_t max_hash_displacement;
};
</code></pre>

<p>ä½¿ç”¨ weak æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡åœ°å€ä½œä¸º key,ç”¨ weak_entry_t ç±»å‹ç»“æ„ä½“å¯¹è±¡ä½œä¸º value.å…¶ä¸­çš„ weak_entries æˆå‘˜,å°±æ˜¯å¼±å¼•ç”¨è¡¨å…¥å£;<br/>
<strong>weak_entry_t</strong><br/>
weak_entry_tè´Ÿè´£ç»´æŠ¤å’Œå­˜å‚¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨ hash è¡¨:</p>

<pre class="line-numbers"><code class="language-text">typedef objc_object ** weak_referrer_t;
struct weak_entry_t {
    DisguisedPtrobjc_object&gt; referent;
    union {
        struct {
            weak_referrer_t *referrers;
            uintptr_t        out_of_line : 1;
            uintptr_t        num_refs : PTR_MINUS_1;
            uintptr_t        mask;
            uintptr_t        max_hash_displacement;
        };
        struct {// out_of_line=0 is LSB of one of these (don&#39;t care which)
            weak_referrer_t  inline_referrers[WEAK_INLINE_COUNT];
        };
    }
}
</code></pre>

<ul>
<li>referent:è¢«å€¼å¯¹è±¡çš„åœ°å€,å‰é¢å¾ªç¯éå†æŸ¥æ‰¾çš„æ—¶å€™å°±æ˜¯åˆ¤æ–­ç›®æ ‡åœ°å€æ˜¯å¦å’Œä»–ç›¸ç­‰</li>
<li>referrers:å¯å˜æ•°ç»„,é‡Œé¢ä¿å­˜ç€æ‰€æŒ‡å‘è¿™ä¸ªå¯¹è±¡çš„å¼±å¼•ç”¨çš„åœ°å€,å½“è¿™ä¸ªå¯¹è±¡è¢«é‡Šæ”¾çš„æ—¶å€™.referrersé‡Œé¢çš„æ‰€æœ‰æŒ‡é’ˆéƒ½ä¼šè¢«ç½®ä¸º nil</li>
<li>inline_referrers:åªæœ‰ 4 ä¸ªå…ƒç´ çš„æ•°ç»„,é»˜è®¤æƒ…å†µä¸‹,ç”¨å®ƒæ¥å­˜å‚¨å¼±å¼•ç”¨çš„æŒ‡é’ˆ,å½“å¤§äº 4 ä¸ªçš„æ—¶å€™ä½¿ç”¨referrersæ¥å­˜å‚¨æŒ‡é’ˆ<br/>
ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤ºå°±æ˜¯:
<img src="media/15820198947096/15820227824222.jpg" alt="" style="width:894px;"/></li>
</ul>

<p><strong>weak_unregister_no_lock</strong><br/>
ä¸‹é¢æ¥çœ‹ä¸€ä¸‹weak_unregister_no_lockæ˜¯æ€ä¹ˆæ¸…é™¤æ—§å€¼çš„</p>

<pre class="line-numbers"><code class="language-text">void weak_unregister_no_lock(weak_table_t *weak_table, id referent_id, 
                        id *referrer_id)
{
    objc_object *referent = (objc_object *)referent_id;
    objc_object **referrer = (objc_object **)referrer_id;

    weak_entry_t *entry;

    if (!referent) return;

    if ((entry = weak_entry_for_referent(weak_table, referent))) {
        remove_referrer(entry, referrer);
        bool empty = true;
        if (entry-&gt;out_of_line  &amp;&amp;  entry-&gt;num_refs != 0) {
            empty = false;
        }
        else {
            for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) {
                if (entry-&gt;inline_referrers[i]) {
                    empty = false; 
                    break;
                }
            }
        }

        if (empty) {
            weak_entry_remove(weak_table, entry);
        }
    }

    // Do not set *referrer = nil. objc_storeWeak() requires that the 
    // value not change.
}
</code></pre>

<p>è¯¥æ–¹æ³•ä¸»è¦ä½œç”¨æ˜¯å°†æ—§å¯¹è±¡åœ¨ weak_table ä¸­è§£é™¤ weak æŒ‡é’ˆçš„å¯¹åº”ç»‘å®š,æ ¹æ®å‡½æ•°åç§°,æˆ‘ä»¬ç§°ä»–ä¸ºè§£é™¤æ³¨å†Œæ“ä½œ<br/>
è¿™ä¸ªå‡½æ•°çš„é€»è¾‘:é¦–å…ˆæ˜¯ weak_table_t è¡¨,é”®å’Œå€¼.å£°æ˜ weak_entry_t å˜é‡,å¦‚æœ key(referent)ä¸ºç©º,ç›´æ¥è¿”å›,æ ¹æ®å…¨å±€å…¥å£è¡¨å’Œé”®è·å–å¯¹åº”çš„ weak_entry_t å¯¹è±¡entry.è·å–åˆ° entry å,å°† entry ä»¥åŠ weak_table ä½œä¸ºå‚æ•°ä¼ å…¥ remove_referrer å‡½æ•°ä¸­,è¿™ä¸ªå‡½æ•°å°±æ˜¯è§£é™¤æ“ä½œ,ç„¶ååˆ¤æ–­ entry æ˜¯å¦ä¸ºç©º,è‹¥æœä¸ºç©º,ä»å…¨å±€è®°å½•è¡¨ä¸­æ¸…é™¤ç›¸åº”çš„ entry.</p>

<p><strong>weak_entry_for_referent</strong></p>

<pre class="line-numbers"><code class="language-text">static weak_entry_t *weak_entry_for_referent(weak_table_t *weak_table, objc_object *referent)
{
    assert(referent);

    weak_entry_t *weak_entries = weak_table-&gt;weak_entries;

    if (!weak_entries) return nil;

    size_t index = hash_pointer(referent) &amp; weak_table-&gt;mask;
    size_t hash_displacement = 0;
    while (weak_table-&gt;weak_entries[index].referent != referent) {
        index = (index+1) &amp; weak_table-&gt;mask;
        hash_displacement++;
        if (hash_displacement &gt; weak_table-&gt;max_hash_displacement) {
            return nil;
        }
    }

    return &amp;weak_table-&gt;weak_entries[index];
}
</code></pre>

<p>è¿™ä¸ªå‡½æ•°çš„é€»è¾‘å°±æ˜¯å…ˆè·å–å…¨å±€ weak è¡¨å…¥å£,ç„¶åå°†å¼•ç”¨è®¡æ•°çš„åœ°å€è¿›è¡Œ hash åŒ–åä¸ weak_table-&gt;mask åšä¸æ“ä½œ,ä½œä¸ºä¸‹æ ‡,åœ¨å…¨å±€ weak è¡¨ä¸­æŸ¥æ‰¾,è‹¥æ‰¾åˆ°,è¿”å› entry,è‹¥æ²¡æœ‰,è¿”å› nil</p>

<p>å‚è€ƒ:<br/>
<a href="https://www.jianshu.com/p/10c0f49f4755">https://www.jianshu.com/p/10c0f49f4755</a><br/>
<a href="https://www.jianshu.com/p/ef6d9bf8fe59">https://www.jianshu.com/p/ef6d9bf8fe59</a><br/>
<a href="https://www.jianshu.com/p/8577286af88e">https://www.jianshu.com/p/8577286af88e</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/02/18</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15815876783958.html">
                
                  <h1>iOS ä¸­çš„é”</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<ul>
<li>è‡ªæ—‹é”(OSSpinLock)</li>
<li>äº’æ–¥é”</li>
<li>pthread_mutex</li>
<li>ä¿¡å·é‡(dispatch_semaphore)</li>
<li>NSLock</li>
<li>é€’å½’é”(NSRecursiveLock)</li>
<li>æ¡ä»¶é”(NSConditionLock)</li>
<li>@synchronized</li>
</ul>

<p><strong>è‡ªæ—‹é”(OSSpinLock)</strong></p>

<blockquote>
<p>è‡ªæ—‹é”å·²ç»ä¸å†å®‰å…¨,æœ‰ä¼˜å…ˆçº§ç¿»è½¬é—®é¢˜,ç°åœ¨è‹¹æœä¹Ÿå·²ç»ä¸å†ä½¿ç”¨</p>
</blockquote>

<p>è‡ªæ—‹é”å’Œäº’æ–¥é”æœ‰ç‚¹ç±»ä¼¼,ä½†æ˜¯è‡ªæ—‹é”ä¸ä¼šå¼•èµ·è°ƒç”¨è€…ç¡çœ .å¦‚æœè‡ªæ—‹é”å·²ç»è¢«åˆ«çš„æ‰§è¡Œå•å…ƒä¿æŒ,è°ƒç”¨è€…å°±ä¸€ç›´å¾ªç¯åœ¨é‚£é‡Œçœ‹æ˜¯å¦è‡ªæ—‹é”çš„ä¿æŒç€å·²ç»é‡Šæ”¾äº†é”,å…¶ä½œç”¨æ˜¯è§£å†³èµ„æºçš„äº’æ–¥ä½¿ç”¨.<br/>
è‡ªæ—‹é”çš„é—®é¢˜:<br/>
    1. è‡ªæ—‹é”ä¸€ç›´å ç”¨ CPU,åœ¨ä»–æœªè·å¾—é”çš„æƒ…å†µä¸‹,ä¸€ç›´è¿è¡Œ-è‡ªæ—‹<br/>
    2. é€’å½’è°ƒç”¨æœ‰å¯èƒ½å¼•èµ·æ­»é”<br/>
    3. è‡ªæ—‹é”é€‚ç”¨äºä½¿ç”¨è€…ä¿æŒé”æ—¶é—´æ¯”è¾ƒçŸ­çš„æƒ…å†µä¸‹</p>

<p><strong>äº’æ–¥é”</strong><br/>
äº’æ–¥é”å±äº sleep-waiting ç±»å‹çš„é”.</p>

<blockquote>
<p>ä¾‹å¦‚åœ¨ä¸€ä¸ªåŒæ ¸çš„æœºå™¨ä¸Šæœ‰ä¸¤ä¸ªçº¿ç¨‹(çº¿ç¨‹Aå’Œçº¿ç¨‹B)ï¼Œå®ƒä»¬åˆ†åˆ«è¿è¡Œåœ¨Core0å’Œ Core1ä¸Šã€‚å‡è®¾çº¿ç¨‹Aæƒ³è¦é€šè¿‡pthread_mutex_lockæ“ä½œå»å¾—åˆ°ä¸€ä¸ªä¸´ç•ŒåŒºçš„é”ï¼Œè€Œæ­¤æ—¶è¿™ä¸ªé”æ­£è¢«çº¿ç¨‹Bæ‰€æŒæœ‰ï¼Œé‚£ä¹ˆçº¿ç¨‹Aå°±ä¼šè¢«é˜»å¡ (blocking)ï¼ŒCore0 ä¼šåœ¨æ­¤æ—¶è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢(Context Switch)å°†çº¿ç¨‹Aç½®äºç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ­¤æ—¶Core0å°±å¯ä»¥è¿è¡Œå…¶ä»–çš„ä»»åŠ¡(ä¾‹å¦‚å¦ä¸€ä¸ªçº¿ç¨‹C)è€Œä¸å¿…è¿›è¡Œå¿™ç­‰å¾…ã€‚è€Œè‡ªæ—‹é”åˆ™ä¸ç„¶ï¼Œå®ƒå±äºbusy-waitingç±»å‹çš„é”ï¼Œå¦‚æœçº¿ç¨‹Aæ˜¯ä½¿ç”¨pthread_spin_lockæ“ä½œå»è¯·æ±‚é”ï¼Œé‚£ä¹ˆçº¿ç¨‹Aå°±ä¼šä¸€ç›´åœ¨ Core0ä¸Šè¿›è¡Œå¿™ç­‰å¾…å¹¶ä¸åœçš„è¿›è¡Œé”è¯·æ±‚ï¼Œç›´åˆ°å¾—åˆ°è¿™ä¸ªé”ä¸ºæ­¢ã€‚</p>
</blockquote>

<p>äº’æ–¥é”: çº¿ç¨‹ä¼šä» sleep(åŠ é”)---&gt;running(è§£é”),è¿‡ç¨‹ä¸­æœ‰ä¸Šä¸‹æ–‡çš„åˆ‡æ¢,CPU çš„æŠ¢å ,ä¿¡å·çš„å‘é€ç­‰å¼€é”€.<br/>
è‡ªæ—‹é”:çº¿ç¨‹ä¸€ç›´éƒ½æ˜¯ running(åŠ é”---&gt;è§£é”),æ­»å¾ªç¯æ£€æµ‹é”çš„æ ‡å¿—ä½</p>

<p>äº’æ–¥é”çš„èµ·å§‹å¼€é”€è¦é«˜äºè‡ªæ—‹é”,ä½†æ˜¯åŸºæœ¬ä¸Šæ˜¯ä¸€åŠ³æ°¸é€¸,ä¸´ç•ŒåŒºæŒæœ‰ğŸ”çš„æ—¶é—´å¤§å°å¹¶ä¸ä¼šå¯¹äº’æ–¥é”çš„å¼€é”€é€ æˆå½±å“,è€Œ<mark>è‡ªæ—‹é”æ˜¯æ­»å¾ªç¯æ£€æµ‹</mark>,åŠ é”å…¨ç¨‹æ¶ˆè€— CPU.èµ·å§‹å¼€é”€è™½ç„¶ä½äºäº’æ–¥é”,ä½†æ˜¯éšç€æŒé”æ—¶é—´å¢åŠ ,åŠ é”å¼€é”€æ˜¯çº¿æ€§å¢é•¿<br/>
äº’æ–¥é”é€‚ç”¨:</p>

<ul>
<li>ä¸´ç•ŒåŒºæœ‰ IO æ“ä½œ</li>
<li>ä¸´ç•ŒåŒºä»£ç å¤åˆ¶æˆ–è€…å¾ªç¯é‡å¤§</li>
<li>ä¸´ç•ŒåŒºç«äº‰éå¸¸æ¿€çƒˆ</li>
<li>å•æ ¸å¤„ç†å™¨</li>
</ul>

<p>è‡ªæ—‹é”é€‚ç”¨:<br/>
ä¸´ç•ŒåŒºæŒé”æ—¶é—´éå¸¸çŸ­ä¸” CPU èµ„æºä¸ç´§å¼ çš„æƒ…å†µ,ä¸€èˆ¬ç”¨äºå¤šæ ¸æœåŠ¡å™¨</p>

<blockquote>
<p>OSSpinLock åœ¨ iOS10.0 ä»¥åå°±è¢«å¼ƒç”¨äº†,å¯ä»¥ä½¿ç”¨ os_unfair_lock_lock æ›¿ä»£.è€Œä¸”å­˜åœ¨ä¼˜å…ˆçº§ç¿»è½¬é—®é¢˜<br/>
ä¼˜å…ˆçº§ç¿»è½¬:ä¸€ä¸ªä½ä¼˜å…ˆçº§çº¿ç¨‹è·å¾—é”å¹¶è®¿é—®å…±äº«èµ„æº,è¿™æ—¶ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¹Ÿå°è¯•è·å¾—è¿™ä¸ªé”,ä»–ä¼šå¤„äº spinlock çš„å¿™ç­‰çŠ¶æ€ä»è€Œå ç”¨å¤§é‡ CPU,æ­¤æ—¶ä½ä¼˜å…ˆçº§æ— æ³•ä¸é«˜ä¼˜å…ˆçº§çº¿ç¨‹äº‰å¤º cpu æ—¶é—´,ä»è€Œå¯¼è‡´ä»»åŠ¡è¿Ÿè¿Ÿæ— æ³•å®Œæˆ,æ— æ³•é‡Šæ”¾ lock.</p>
</blockquote>

<p><strong>os_unfair_lock</strong></p>

<p>os_unfair_lockç”¨äºå–ä»£ä¸å®‰å…¨çš„ OSSpinLock,ä» iOS10 å¼€å§‹æ”¯æŒ,åº•å±‚è°ƒç”¨çœ‹,ç­‰å¾…os_unfair_locké”çš„çº¿ç¨‹ä¼šå¤„äºä¼‘çœ çŠ¶æ€,å¹¶éå¿™ç­‰,éœ€è¦å¯¼å…¥å¤´æ–‡ä»¶#import <os/lock.h></p>

<p><strong>pthread_mutex</strong><br/>
mutex å«åšäº’æ–¥é”.ç­‰å¾…é”çš„çº¿ç¨‹ä¼šå¤„äºä¼‘çœ çŠ¶æ€,å¹¶ä¸”æ”¯æŒé€’å½’,æ€§èƒ½å’Œç¨³å®šæ€§æ˜¯å…¬è®¤æœ€å¥½çš„,æ¯”è¾ƒæ¨èä½¿ç”¨,pthread_mutexçš„ç¼ºç‚¹æ˜¯åªèƒ½ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”,å¹¶ä¸”é˜»å¡ç­‰å¾…å¯¹è±¡(è¿™ä¹Ÿæ˜¯ä»–æ¯”è‡ªæ—‹é”æ…¢çš„åŸå› )</p>

<p><strong>NSLock</strong><br/>
NSLockæ˜¯å¯¹ mutex çš„æ™®é€šé”çš„å°è£…<br/>
NSLockéµå¾ª NSLocking åè®®,lock æ–¹æ³•æ˜¯åŠ é”,unlock æ˜¯è§£é”.<br/>
trylock æ˜¯å°è¯•åŠ é”,å¦‚æœå¤±è´¥çš„è¯å°±è¿”å› NO</p>

<p><strong>ä¿¡å·é‡</strong><br/>
    * ä¿¡å·é‡çš„åˆå§‹å€¼,å¯ä»¥ç”¨æ¥æ§åˆ¶çº¿ç¨‹å¹¶å‘è®¿é—®çš„æœ€å¤§æ•°é‡<br/>
    * ä¿¡å·é‡çš„åˆå§‹å€¼ä¸º 1,ä»£è¡¨åŒæ—¶åªå…è®¸ 1 æ¡çº¿ç¨‹è®¿é—®èµ„æº,ä¿è¯çº¿ç¨‹åŒæ­¥</p>

<pre class="line-numbers"><code class="language-text">dispatch_semaphore_createå¯ä»¥ç”Ÿäº§ä¿¡å·é‡,å‚æ•° value æ˜¯ä¿¡å·é‡çš„åˆå§‹å€¼
dispatch_semaphore_waitä¼šè®©ä¿¡å·é‡çš„å€¼å‡ä¸€,å½“ä¿¡å·é‡çš„å€¼ä¸º 0 æ—¶ä¼šç­‰å¾…(ç›´åˆ°è¶…æ—¶),å¦åˆ™æ­£å¸¸æ‰§è¡Œ
dispatch_semaphore_signalä¼šè®©ä¿¡å·é‡çš„å€¼åŠ ä¸€,å¦‚æœæœ‰é€šè¿‡dispatch_semaphore_waitå‡½æ•°ç­‰å¾…Dispatch Semaphoreçš„è®¡æ•°å€¼å¢åŠ çš„çº¿ç¨‹,ä¼šæœ‰ç³»ç»Ÿå”¤é†’æœ€å…ˆç­‰å¾…çš„çº¿ç¨‹æ‰§è¡Œ
ç”¨æ³•:
ä¿¡å·é‡å¸¸ç”¨äºå¯¹èµ„æºè¿›è¡ŒåŠ é”æ“ä½œ
</code></pre>

<pre class="line-numbers"><code class="language-text">//åœ¨initç­‰å‡½æ•°åˆå§‹åŒ–
_lock = dispatch_semaphore_create(1); 
dispatch_semaphore_wait(_lock, DISPATCH_TIME_FOREVER); 
//ä¿®æ”¹Arrayæˆ–å­—å…¸ç­‰æ•°æ®çš„ä¿¡æ¯
dispatch_semaphore_signal(_lock);
</code></pre>

<p><strong>@synchronized</strong><br/>
@synchronizedå¯ä»¥ç»™ä»»ä½• OC å¯¹è±¡åŠ é”,ä¸è¿‡@synchronizedæ˜¯æ•ˆç‡æœ€ä½çš„æ–¹æ¡ˆ,å› ä¸ºä»–çš„ block ä¼šéšå¼æ·»åŠ å¼‚å¸¸å¤„ç†æ¥ä¿æŠ¤ä»£ç å—,æœ‰ç‚¹æ˜¯ä¹¦å†™æ¯”è¾ƒç®€ä¾¿.</p>

<pre class="line-numbers"><code class="language-text">// å†™æ•°æ®
dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
    @synchronized (dict) {
        [dict setObject:@&quot;boz&quot; forKey:@&quot;trail&quot;];
    }
});
// è¯»æ•°æ®
dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
    @synchronized (dict) {
        id obj = [dict objectForKey:@&quot;trail&quot;];
    }
});
</code></pre>

<p>å‚è€ƒ:<br/>
<a href="https://xiaozhuanlan.com/topic/4365017982">https://xiaozhuanlan.com/topic/4365017982</a><br/>
<a href="https://juejin.im/post/5bf21d935188251d9e0c2937">https://juejin.im/post/5bf21d935188251d9e0c2937</a><br/>
<a href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/">https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/02/13</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15795063924352.html">
                
                  <h1>AutoReleasePool è‡ªåŠ¨é‡Šæ”¾æ± </h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<ul>
<li>Appå¯åŠ¨åï¼Œè‹¹æœåœ¨ä¸»çº¿ç¨‹ RunLoop é‡Œæ³¨å†Œäº†ä¸¤ä¸ª Observerï¼Œå…¶å›è°ƒéƒ½æ˜¯ _wrapRunLoopWithAutoreleasePoolHandler()ã€‚</li>
<li>ç¬¬ä¸€ä¸ª Observer ç›‘è§†çš„äº‹ä»¶æ˜¯ Entry(å³å°†è¿›å…¥Loop)ï¼Œå…¶å›è°ƒå†…ä¼šè°ƒç”¨ _objc_autoreleasePoolPush() åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚å…¶ order æ˜¯-2147483647ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºé‡Šæ”¾æ± å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚</li>
<li>ç¬¬äºŒä¸ª Observer ç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶ï¼š BeforeWaiting(å‡†å¤‡è¿›å…¥ä¼‘çœ ) æ—¶è°ƒç”¨_objc_autoreleasePoolPop() å’Œ _objc_autoreleasePoolPush() é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ï¼›Exit(å³å°†é€€å‡ºLoop) æ—¶è°ƒç”¨ _objc_autoreleasePoolPop() æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™ä¸ª Observer çš„ order æ˜¯ 2147483647ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶é‡Šæ”¾æ± å­å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹åã€‚</li>
<li>åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œé€šå¸¸æ˜¯å†™åœ¨è¯¸å¦‚äº‹ä»¶å›è°ƒã€Timerå›è°ƒå†…çš„ã€‚è¿™äº›å›è°ƒä¼šè¢« RunLoop åˆ›å»ºå¥½çš„ AutoreleasePool ç¯ç»•ç€ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼Œå¼€å‘è€…ä¹Ÿä¸å¿…æ˜¾ç¤ºåˆ›å»º Pool äº†ã€‚</li>
</ul>

<p>ä¹Ÿå°±æ˜¯è¯´<mark>AutoreleasePoolåˆ›å»ºæ˜¯åœ¨ä¸€ä¸ªRunLoopäº‹ä»¶å¼€å§‹ä¹‹å‰(push)ï¼ŒAutoreleasePoolé‡Šæ”¾æ˜¯åœ¨ä¸€ä¸ªRunLoopäº‹ä»¶å³å°†ç»“æŸä¹‹å‰(pop)ã€‚</mark><br/>
AutoreleasePoolé‡Œçš„Autoreleaseå¯¹è±¡çš„åŠ å…¥æ˜¯åœ¨RunLoopäº‹ä»¶ä¸­ï¼ŒAutoreleasePoolé‡Œçš„Autoreleaseå¯¹è±¡çš„é‡Šæ”¾æ˜¯åœ¨AutoreleasePoolé‡Šæ”¾æ—¶ã€‚</p>

<h2 id="toc_0">Autoreleaseå¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼Ÿ</h2>

<p>åœ¨æ²¡æœ‰æ‰‹åŠ¨æ·»åŠ  AutoreleasePoolçš„æƒ…å†µä¸‹,<br/>
**Autoreleaseå¯¹è±¡æ˜¯åœ¨å½“å‰çš„ RunLoop è¿­ä»£ç»“æŸçš„æ—¶å€™é‡Šæ”¾çš„ **<br/>
åŸå› :<br/>
    ç³»ç»Ÿåœ¨æ¯ä¸ª RunLoop è¿­ä»£ä¸­éƒ½åŠ å…¥äº†è‡ªåŠ¨é‡Šæ”¾æ± çš„ Push å’Œ Pop</p>

<h2 id="toc_1">AutoreleasePoolåŸç†</h2>

<p><img src="media/15795063924352/15795107102374.jpg" alt="" style="width:702px;"/></p>

<p><img src="media/15795063924352/15795070852300.jpg" alt="" style="width:536px;"/></p>

<ul>
<li>AutoreleasePoolå¹¶æ²¡æœ‰å•ç‹¬çš„ç»“æ„,è€Œæ˜¯ç”±è‹¥å¹²ä¸ª AutoreleasePoolPage ä»¥åŒå‘é“¾è¡¨çš„å½¢å¼ç»“åˆè€Œæˆ(åˆ†åˆ«å¯¹åº”å›¾ä¸­çš„ parent å’Œ child æŒ‡é’ˆ)</li>
<li>AutoreleasePoolæ˜¯æŒ‰çº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„(ç»“æ„ä¸­çš„ thread æŒ‡å‘å½“å‰çº¿ç¨‹)</li>
<li>AutoreleasePoolPage æ¯ä¸ªå¯¹è±¡ä¼šå¼€è¾Ÿ 4096 ä¸ªå­—èŠ‚å†…å­˜(ä¸€é¡µè™šæ‹Ÿå†…å­˜çš„å¤§å°)é™¤äº†ä¸Šé¢çš„å®ä¾‹å˜é‡æ‰€å çš„ç©ºé—´,å‰©ä¸‹çš„ç©ºé—´éƒ½ç”¨æ¥å­˜å‚¨ Autoreleaseå¯¹è±¡</li>
<li>ä¸Šé¢çš„ id *next æŒ‡é’ˆä½œä¸ºæ¸¸æ ‡æŒ‡å‘æ ˆé¡¶æœ€æ–° add è¿›æ¥çš„ Autoreleaseå¯¹è±¡çš„ä¸‹ä¸€ä¸ªä½ç½®</li>
<li>ä¸€ä¸ª AutoreleasePoolPage çš„ç©ºé—´è¢«æ²¾æ»¡æ—¶,ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ AutoreleasePoolPage å¯¹è±¡,è¿æ¥é“¾è¡¨,åæ¥çš„ Autoreleaseå¯¹è±¡åœ¨æ–°çš„ page åŠ å…¥</li>
</ul>

<p>æ‰€ä»¥è‹¥å½“å‰çº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ª AutoreleasePoolPage å¯¹è±¡,å¹¶è®°å½•äº†å¾ˆå¤š Autoreleaseå¯¹è±¡åœ°å€æ—¶,å†…å­˜:<br/>
<img src="media/15795063924352/15795075970216.jpg" alt="" style="width:520px;"/><br/>
å›¾ä¸­çš„æƒ…å†µï¼Œè¿™ä¸€é¡µå†åŠ å…¥ä¸€ä¸ªautoreleaseå¯¹è±¡å°±è¦æ»¡äº†ï¼ˆä¹Ÿå°±æ˜¯nextæŒ‡é’ˆé©¬ä¸ŠæŒ‡å‘æ ˆé¡¶ï¼‰ï¼Œè¿™æ—¶å°±è¦æ‰§è¡Œä¸Šé¢è¯´çš„æ“ä½œï¼Œå»ºç«‹ä¸‹ä¸€é¡µpageå¯¹è±¡ï¼Œä¸è¿™ä¸€é¡µé“¾è¡¨è¿æ¥å®Œæˆåï¼Œæ–°pageçš„nextæŒ‡é’ˆè¢«åˆå§‹åŒ–åœ¨æ ˆåº•ï¼ˆbeginçš„ä½ç½®ï¼‰ï¼Œç„¶åç»§ç»­å‘æ ˆé¡¶æ·»åŠ æ–°å¯¹è±¡ã€‚</p>

<p><mark><strong>å‘ä¸€ä¸ªå¯¹è±¡å‘é€- autoreleaseæ¶ˆæ¯ï¼Œå°±æ˜¯å°†è¿™ä¸ªå¯¹è±¡åŠ å…¥åˆ°å½“å‰AutoreleasePoolPageçš„æ ˆé¡¶nextæŒ‡é’ˆæŒ‡å‘çš„ä½ç½®</strong></mark><br/>
è¿™ä¸€æ­¥åªæ˜¯æŠŠ Autoreleaseå¯¹è±¡åŠ å…¥åˆ°äº†è‡ªåŠ¨é‡Šæ”¾æ± ,è¿˜å¹¶æ²¡æœ‰é‡Šæ”¾</p>

<h3 id="toc_2">çœŸæ­£é‡Šæ”¾æ—¶åˆ»</h3>

<p>æ¯å½“è¿›è¡Œä¸€æ¬¡<mark><strong>objc_autoreleasePoolPush</strong></mark>è°ƒç”¨æ—¶ï¼Œruntimeå‘å½“å‰çš„AutoreleasePoolPageä¸­addè¿›ä¸€ä¸ªå“¨å…µå¯¹è±¡ï¼Œå€¼ä¸º0ï¼ˆä¹Ÿå°±æ˜¯ä¸ªnilï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸€ä¸ªpageå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­ï¼š<br/>
<img src="media/15795063924352/15795082558655.jpg" alt="" style="width:754px;"/><br/>
<mark>objc_autoreleasePoolPush</mark>çš„è¿”å›å€¼æ­£æ˜¯è¿™ä¸ªå“¨å…µå¯¹è±¡çš„åœ°å€ï¼Œè¢«<mark>objc_autoreleasePoolPop</mark>(å“¨å…µå¯¹è±¡)ä½œä¸ºå…¥å‚ï¼Œäºæ˜¯ï¼š</p>

<ol>
<li> æ ¹æ®ä¼ å…¥çš„å“¨å…µå¯¹è±¡åœ°å€æ‰¾åˆ°å“¨å…µå¯¹è±¡æ‰€å¤„çš„page</li>
<li>åœ¨å½“å‰pageä¸­ï¼Œå°†æ™šäºå“¨å…µå¯¹è±¡æ’å…¥çš„æ‰€æœ‰autoreleaseå¯¹è±¡éƒ½å‘é€ä¸€æ¬¡- releaseæ¶ˆæ¯ï¼Œå¹¶å‘å›ç§»åŠ¨nextæŒ‡é’ˆåˆ°æ­£ç¡®ä½ç½®</li>
<li>è¡¥å……2ï¼šä»æœ€æ–°åŠ å…¥çš„å¯¹è±¡ä¸€ç›´å‘å‰æ¸…ç†ï¼Œå¯ä»¥å‘å‰è·¨è¶Šè‹¥å¹²ä¸ªpageï¼Œç›´åˆ°å“¨å…µæ‰€åœ¨çš„page<br/>
åˆšæ‰çš„objc_autoreleasePoolPopæ‰§è¡Œåï¼Œ
<img src="media/15795063924352/15795086281414.jpg" alt="" style="width:758px;"/>
æœ€ç»ˆå˜æˆäº†ä¸‹é¢çš„æ ·å­:
<img src="media/15795063924352/15795084636880.jpg" alt="" style="width:725px;"/></li>
</ol>

<p><strong>åµŒå¥—çš„AutoreleasePool</strong><br/>
çŸ¥é“äº†ä¸Šé¢çš„åŸç†ï¼ŒåµŒå¥—çš„AutoreleasePoolå°±éå¸¸ç®€å•äº†ï¼Œpopçš„æ—¶å€™æ€»ä¼šé‡Šæ”¾åˆ°ä¸Šæ¬¡pushçš„ä½ç½®ä¸ºæ­¢ï¼Œå¤šå±‚çš„poolå°±æ˜¯å¤šä¸ªå“¨å…µå¯¹è±¡è€Œå·²ï¼Œå°±åƒå‰¥æ´‹è‘±ä¸€æ ·ï¼Œæ¯æ¬¡ä¸€å±‚ï¼Œäº’ä¸å½±å“ã€‚ </p>

<p><img src="media/15795063924352/15795095043776.jpg" alt="" style="width:767px;"/></p>

<p><img src="media/15795063924352/15795109308256.jpg" alt="" style="width:700px;"/></p>

<p>æ³¨æ„ç‚¹:<br/>
NSAutoRelasePoolå¯¹è±¡æ‰§è¡Œé”€æ¯æ—¶[pool drain]åï¼Œè‡ªåŠ¨é‡Šæ”¾æ± ä¼šæŠŠæ·»åŠ åˆ°è¯¥poolé‡Œé¢çš„æ‰€æœ‰OCå¯¹è±¡éƒ½æ‰§è¡Œä¸€éreleaseï¼ˆretainCount-=1ï¼‰ï¼Œå¦‚æœæ°å¥½æ­¤æ—¶retainCount&lt;=0 ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨<mark>dealloc</mark>æ–¹æ³•åºŸå¼ƒå¯¹è±¡ã€‚</p>

<p>å‚è€ƒ:<br/>
<a href="https://www.jianshu.com/p/61d8131c6bf3">https://www.jianshu.com/p/61d8131c6bf3</a><br/>
<a href="https://blog.sunnyxx.com/2014/10/15/behind-autorelease/">https://blog.sunnyxx.com/2014/10/15/behind-autorelease/</a><br/>
<a href="https://juejin.im/post/5d7765756fb9a06af82503b6">https://juejin.im/post/5d7765756fb9a06af82503b6</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/01/20</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15791552193020.html">
                
                  <h1>RunLoop è¯¦è§£</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<ul>
<li>RunLoop æ¦‚å¿µ</li>
<li>RunLoopä¸çº¿ç¨‹çš„å…³ç³»<br/>
## RunLoop æ¦‚å¿µ<br/>
ä¸€èˆ¬æ¥è®²ä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡,æ‰§è¡Œå®Œæˆåçº¿ç¨‹å°±ä¼šæ¨å‡ºäº†,å¾ˆæ˜æ˜¾,ç°åœ¨çš„ APP éƒ½æ˜¯ä¸å¯èƒ½è¿™ç§æ¨¡å¼çš„,å¦åˆ™ APP æ‰“å¼€ä¹‹åå°±æ­»æ‰äº†,ä¹Ÿå°±æ²¡æœ‰ä»»ä½•ä½œç”¨äº†.<br/>
ç°åœ¨çš„è¿™ç§æ¨¡å¼å…¶å®æ˜¯ä¸€ç§å¾ªç¯æ¨¡å¼,ä¿æŒä¸€ä¸ªçº¿ç¨‹å§‹ç»ˆå­˜åœ¨,ç„¶åå†å¤„ç†å„ç§æ“ä½œ(åŠŸèƒ½)ç­‰.<br/>
ç°åœ¨ APP çš„å®ç°æœºåˆ¶å…¶å®æ˜¯éœ€è¦çº¿ç¨‹èƒ½éšæ—¶å¤„ç†äº‹ä»¶,ä½†æ˜¯å¹¶ä¸é€€å‡º,é€šå¸¸çš„ä»£ç é€»è¾‘æ˜¯è¿™æ ·çš„:(ä¼ªä»£ç )
<img src="media/15791552193020/15794166325797.jpg" alt="" style="width:772px;"/>
ä»ä»£ç å¯ä»¥çœ‹å‡ºæ˜¯ä¸€ç§å¾ªç¯æœºåˆ¶.<br/>
è¿™ç§æ¨¡å¼é€šå¸¸è¢«ç§°ä¸º EventLoop.iOS/OSXé‡Œçš„ runloop å°±æ˜¯è¿™ç§æ¨¡å¼.<br/>
è¿™ç§æ¨¡å¼çš„å…³é”®ç‚¹:
<ul>
<li>å¦‚ä½•ç®¡ç†äº‹ä»¶/æ¶ˆæ¯</li>
<li>å¦‚ä½•è®©çº¿ç¨‹åœ¨æ²¡æœ‰æ¶ˆæ¯å¤„ç†çš„æ—¶å€™ä¼‘çœ ,é¿å…å ç”¨èµ„æº</li>
<li>åœ¨æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†çš„æ—¶å€™ç«‹åˆ»è¢«å”¤é†’(å¦åˆ™å°±æ˜¯å¡é¡¿äº†)</li>
</ul></li>
</ul>

<p>æ‰€ä»¥ runloop å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¯¹è±¡,è¿™ä¸ªå¯¹è±¡ç®¡ç†äº†éœ€è¦å…¶å¤„ç†çš„äº‹ä»¶å’Œæ¶ˆæ¯.å¹¶ä¸”æä¾›äº†ä¸€ä¸ªå…¥å£å‡½æ•°æ¥æ‰§è¡Œä¸Šé¢çš„ EventLoop é€»è¾‘.<br/>
çº¿ç¨‹æ‰§è¡Œäº†è¿™ä¸ªå‡½æ•°ä¹‹å,å°±ä¼šä¸€ç›´å¤„äºè¿™ä¸ªå‡½æ•°å†…éƒ¨&quot;æ¥å—æ¶ˆæ¯-&gt;ç­‰å¾…-&gt;å¤„ç†&quot;çš„å¾ªç¯ä¸­,çŸ¥é“è¿™ä¸ªå¾ªç¯ç»“æŸ,å‡½æ•°è¿”å›.<br/>
OSX/iOS ä¸­æä¾›äº†ä¸¤ä¸ªè¿™æ ·å¯¹è±¡:<strong>NSRunLoop,CFRunLoopRef</strong> .</p>

<ul>
<li>CFRunLoopRef æ˜¯åœ¨ CoreFoundation æ¡†æ¶å†…çš„,æä¾›çš„çº¯ C å‡½æ•°çš„ API,æ‰€æœ‰è¿™äº› API éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„.</li>
<li>NSRunLoop æ˜¯åŸºäº CFRunLoopRef çš„å°è£…,æä¾›äº†é¢å‘å¯¹è±¡çš„ API,ä½†æ˜¯è¿™äº› API ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
</ul>

<h2 id="toc_0">RunLoop ä¸çº¿ç¨‹çš„å…³ç³»</h2>

<p>å…ˆç»™ç»“è®º:<br/>
   1. RunLoop å’Œçº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„.<br/>
   2. RunLoop å’Œçº¿ç¨‹çš„å¯¹åº”å…³ç³»ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„å­—å…¸é‡Œ<br/>
   3. çº¿ç¨‹åˆšåˆ›å»ºçš„æ—¶å€™æ˜¯æ²¡æœ‰ RunLoop çš„,å¦‚æœä¸ä¸»åŠ¨è·å–å°±ä¸€ç›´ä¸ä¼šæœ‰!<br/>
   4. RunLoop çš„åˆ›å»ºæ˜¯å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶.<br/>
   5. RunLoop çš„é”€æ¯æ˜¯å‘ç”Ÿåœ¨çº¿ç¨‹ç»“æŸæ—¶<br/>
   6. ä½ åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨è·å–å…¶ RunLoop(ä¸»çº¿ç¨‹é™¤å¤–)<br/>
   7. è‹¹æœå¹¶ä¸å…è®¸ä¸»åŠ¨åˆ›å»º RunLoop,åªæä¾›äº†ä¸¤ä¸ªè·å–çš„å‡½æ•°:CFRunLoopGetMain(),CFRunLoopGetCurrent().<br/>
<img src="media/15791552193020/15794176750269.jpg" alt="" style="width:916px;"/></p>

<p>åœ¨ CoreFoundation ä¸­å…³äº RunLoop æœ‰ 5 ä¸ªç±»:</p>

<ul>
<li>CFRunLoopRef</li>
<li>CFRunLoopModeRef</li>
<li>CFRunLoopSourceRef</li>
<li>CFRunLoopTimerRef</li>
<li>CFRunLoopObserverRef<br/>
å…¶ä¸­çš„ CFRunLoopModeRef å¹¶æ²¡æœ‰å¯¹å¤–æš´éœ²,åªæ˜¯é€šè¿‡ CFRunLoopRef çš„æ¥å£å¯¹å¤–è¿›è¡Œäº†å°è£…
<img src="media/15791552193020/15794179265453.jpg" alt="" style="width:724px;"/>
ä¸€ä¸ª RunLoop åŒ…å«è‹¥å¹²ä¸ª Modeï¼Œæ¯ä¸ª Mode åˆåŒ…å«è‹¥å¹²ä¸ª Source/Timer/Observerã€‚æ¯æ¬¡è°ƒç”¨ RunLoop çš„ä¸»å‡½æ•°æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ª Modeï¼Œè¿™ä¸ªModeè¢«ç§°ä½œ CurrentModeã€‚
<strong>å¦‚æœéœ€è¦åˆ‡æ¢ Modeï¼Œåªèƒ½é€€å‡º Loopï¼Œå†é‡æ–°æŒ‡å®šä¸€ä¸ª Mode è¿›å…¥ã€‚è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åˆ†éš”å¼€ä¸åŒç»„çš„ Source/Timer/Observerï¼Œè®©å…¶äº’ä¸å½±å“ã€‚</strong></li>
</ul>

<p><strong>CFRunLoopSourceRef</strong> æ˜¯äº‹ä»¶äº§ç”Ÿçš„åœ°æ–¹ã€‚Sourceæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼šSource0 å’Œ Source1ã€‚</p>

<ol>
<li>Source0 åªåŒ…å«äº†ä¸€ä¸ªå›è°ƒ(å‡½æ•°æŒ‡é’ˆ)</li>
<li><p>Source1 åŒ…å«äº†ä¸€ä¸ªå›è°ƒ(å‡½æ•°æŒ‡é’ˆ)å’Œä¸€ä¸ª mach_port</p>
<p>Source0 å¹¶ä¸èƒ½ä¸»åŠ¨è§¦å‘äº‹ä»¶,ä½¿ç”¨çš„æ—¶å€™éœ€è¦å…ˆè°ƒç”¨CFRunLoopSourceSignal(source)ï¼Œå°†è¿™ä¸ª Source æ ‡è®°ä¸ºå¾…å¤„ç†,ç„¶åæ‰‹åŠ¨è°ƒç”¨CFRunLoopWakeUp(runloop) æ¥å”¤é†’ RunLoopï¼Œè®©å…¶å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚<br/>
Source1 èƒ½ä¸»åŠ¨å”¤é†’ RunLoop çš„çº¿ç¨‹.é€šå¸¸ç”¨äºå†…æ ¸å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯</p></li>
</ol>

<p><strong>CFRunLoopTimerRef</strong> æ˜¯åŸºäºæ—¶é—´çš„è§¦å‘å™¨,å®ƒå’Œ NSTimer æ˜¯toll-free bridged <sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup> çš„,å¯ä»¥æ··ç”¨.å…¶åŒ…å«ä¸€ä¸ªæ—¶é—´é•¿åº¦å’Œä¸€ä¸ªå›è°ƒ(å‡½æ•°æŒ‡é’ˆ).å½“å…¶åŠ å…¥ RunLoop ä¸­æ—¶,RunLoop ä¼šæ³¨å†Œå¯¹åº”çš„æ—¶é—´ç‚¹,å½“æ—¶é—´ç‚¹åˆ°äº†,RunLoop ä¼šè¢«å”¤é†’ä»¥æ‰§è¡Œé‚£ä¸ªå›è°ƒ.</p>

<p><strong>CFRunLoopObserverRef</strong> æ˜¯è§‚å¯Ÿè€…,æ¯ä¸ª Observer éƒ½åŒ…å«äº†ä¸€ä¸ªå›è°ƒ(å‡½æ•°æŒ‡é’ˆ),å½“ RunLoop çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶,è§‚å¯Ÿè€…å°±èƒ½é€šè¿‡å›è°ƒæ¥å—åˆ°è¿™ä¸ªå˜åŒ–.å¯ä»¥è§‚å¯Ÿçš„æ—¶é—´ç‚¹:<br/>
<img src="media/15791552193020/15794192089256.jpg" alt="" style="width:995px;"/></p>

<p>ä¸Šé¢çš„ Source/Timer/Observer è¢«ç»Ÿç§°ä¸º mode itemï¼Œä¸€ä¸ª item å¯ä»¥è¢«åŒæ—¶åŠ å…¥å¤šä¸ª modeã€‚ä½†ä¸€ä¸ª item è¢«é‡å¤åŠ å…¥åŒä¸€ä¸ª mode æ—¶æ˜¯ä¸ä¼šæœ‰æ•ˆæœçš„ã€‚å¦‚æœä¸€ä¸ª mode ä¸­ä¸€ä¸ª item éƒ½æ²¡æœ‰ï¼Œåˆ™ RunLoop ä¼šç›´æ¥é€€å‡ºï¼Œä¸è¿›å…¥å¾ªç¯ã€‚</p>

<h2 id="toc_1">RunLoop çš„ Mode</h2>

<p>CFRunLoopMode å’Œ CFRunLoop çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š<br/>
<img src="media/15791552193020/15794203021817.jpg" alt="" style="width:1225px;"/><br/>
è¿™é‡Œæœ‰ä¸€ä¸ªæ¦‚å¿µå«&quot;CommonModes&quot;:<br/>
    ä¸€ä¸ª Mode å¯ä»¥å°†è‡ªå·±æ ‡è®°ä¸º&quot;common&quot;å±æ€§(é€šè¿‡å°†å…¶ ModeName æ·»åŠ åˆ° RunLoop çš„&quot;commonModes&quot;ä¸­),æ¯å½“ Runloop çš„å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶,RunLoop ä¼šè‡ªåŠ¨å°†_commonModeItems é‡Œçš„ Source/Obsever/Timer åŒæ­¥åˆ°å…·æœ‰ Common æ ‡è®°çš„æ‰€æœ‰ Mode é‡Œ<br/><br/>
<img src="media/15791552193020/15794205749856.jpg" alt="" style="width:1527px;"/><br/>
<img src="media/15791552193020/15794206571347.jpg" alt="" style="width:1537px;"/></p>

<h2 id="toc_2">RunLoop çš„å†…éƒ¨é€»è¾‘</h2>

<p>æ ¹æ®è‹¹æœåœ¨æ–‡æ¡£é‡Œçš„è¯´æ˜ï¼ŒRunLoop å†…éƒ¨çš„é€»è¾‘å¤§è‡´å¦‚ä¸‹:<br/>
<img src="media/15791552193020/15794207296297.jpg" alt="" style="width:1118px;"/></p>

<p>å†…éƒ¨ä»£ç æ•´ç†:<br/>
<img src="media/15791552193020/FireShot%20Capture%20023%20-%20%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3RunLoop%20-%20Garan%20no%20dou%20-%20blog.ibireme.com.png" alt="FireShot Capture 023 - æ·±å…¥ç†è§£RunLoop - Garan no dou - blog.ibireme.co"/><br/>
å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Š RunLoop å°±æ˜¯è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ª do-while å¾ªç¯ã€‚å½“ä½ è°ƒç”¨ CFRunLoopRun() æ—¶ï¼Œçº¿ç¨‹å°±ä¼šä¸€ç›´åœç•™åœ¨è¿™ä¸ªå¾ªç¯é‡Œï¼›ç›´åˆ°è¶…æ—¶æˆ–è¢«æ‰‹åŠ¨åœæ­¢ï¼Œè¯¥å‡½æ•°æ‰ä¼šè¿”å›ã€‚</p>

<h2 id="toc_3">è‹¹æœç”¨ Runloop å®ç°çš„åŠŸèƒ½</h2>

<ol>
<li>kCFRunLoopDefaultMode: Appçš„é»˜è®¤ Modeï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ª Mode ä¸‹è¿è¡Œçš„ã€‚</li>
<li>UITrackingRunLoopMode: ç•Œé¢è·Ÿè¸ª Modeï¼Œç”¨äº ScrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»– Mode å½±å“ã€‚</li>
<li>UIInitializationRunLoopMode: åœ¨åˆšå¯åŠ¨ App æ—¶ç¬¬è¿›å…¥çš„ç¬¬ä¸€ä¸ª Modeï¼Œå¯åŠ¨å®Œæˆåå°±ä¸å†ä½¿ç”¨ã€‚<br/>
4: GSEventReceiveRunLoopMode: æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨ Modeï¼Œé€šå¸¸ç”¨ä¸åˆ°ã€‚<br/>
5: kCFRunLoopCommonModes: è¿™æ˜¯ä¸€ä¸ªå ä½çš„ Modeï¼Œæ²¡æœ‰å®é™…ä½œç”¨ã€‚</li>
</ol>

<h3 id="toc_4">AutoreleasePool</h3>

<p>App å¯åŠ¨ä¹‹å,è‹¹æœåœ¨ä¸»çº¿ç¨‹ RunLoop é‡Œæ³¨å†Œäº†ä¸¤ä¸ª Observer,è¿™ä¸¤ä¸ªè§‚å¯Ÿè€…çš„å›è°ƒéƒ½æ˜¯_wrapRunLoopWithAutoreleasePoolHandler().</p>

<ul>
<li>ç¬¬ä¸€ä¸ª Observer ç›‘è§†çš„äº‹ä»¶æ˜¯ Entry(å³å°†è¿›å…¥ Loop)å…¶å›è°ƒå›è°ƒç”¨_objc_autoreleasePoolPush()åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ,ä¼˜å…ˆçº§æœ€é«˜,ä¿è¯åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± åœ¨æ‰€æœ‰å›è°ƒä¹‹å‰</li>
<li>ç¬¬äºŒä¸ª Observer ç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶:
<ol>
<li>BeforeWaiting(å‡†å¤‡è¿›å…¥ä¼‘çœ )æ—¶è°ƒç”¨_objc_autoreleasePoolPop()å’Œ_objc_autoreleasePoolPush()é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°çš„è‡ªåŠ¨é‡Šæ”¾æ± ;</li>
<li>Exit(é€€å‡ºLoop)æ—¶è°ƒç”¨_objc_autoreleasePoolPop()é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ,è¿™ä¸ª Observer çš„ä¼˜å…ˆçº§æœ€ä½,ä¿è¯é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± å‘ç”Ÿåœ¨æ‰€æœ‰å›è°ƒä¹‹å</li>
</ol></li>
</ul>

<h3 id="toc_5">äº‹ä»¶å“åº”</h3>

<p>è‹¹æœæ³¨å†Œäº†ä¸€ä¸ª Source1 (åŸºäº mach port çš„) ç”¨æ¥æ¥æ”¶ç³»ç»Ÿäº‹ä»¶ï¼Œå…¶å›è°ƒå‡½æ•°ä¸º __IOHIDEventSystemClientQueueCallback()ã€‚</p>

<p>å½“ä¸€ä¸ªç¡¬ä»¶äº‹ä»¶(è§¦æ‘¸/é”å±/æ‘‡æ™ƒç­‰)å‘ç”Ÿåï¼Œé¦–å…ˆç”± IOKit.framework ç”Ÿæˆä¸€ä¸ª IOHIDEvent äº‹ä»¶å¹¶ç”± SpringBoard æ¥æ”¶ã€‚è¿™ä¸ªè¿‡ç¨‹çš„è¯¦ç»†æƒ…å†µå¯ä»¥å‚è€ƒè¿™é‡Œã€‚SpringBoard åªæ¥æ”¶æŒ‰é”®(é”å±/é™éŸ³ç­‰)ï¼Œè§¦æ‘¸ï¼ŒåŠ é€Ÿï¼Œæ¥è¿‘ä¼ æ„Ÿå™¨ç­‰å‡ ç§ Eventï¼Œéšåç”¨ mach port è½¬å‘ç»™éœ€è¦çš„Appè¿›ç¨‹ã€‚éšåè‹¹æœæ³¨å†Œçš„é‚£ä¸ª Source1 å°±ä¼šè§¦å‘å›è°ƒï¼Œå¹¶è°ƒç”¨ _UIApplicationHandleEventQueue() è¿›è¡Œåº”ç”¨å†…éƒ¨çš„åˆ†å‘ã€‚</p>

<p>_UIApplicationHandleEventQueue() ä¼šæŠŠ IOHIDEvent å¤„ç†å¹¶åŒ…è£…æˆ UIEvent è¿›è¡Œå¤„ç†æˆ–åˆ†å‘ï¼Œå…¶ä¸­åŒ…æ‹¬è¯†åˆ« UIGesture/å¤„ç†å±å¹•æ—‹è½¬/å‘é€ç»™ UIWindow ç­‰ã€‚é€šå¸¸äº‹ä»¶æ¯”å¦‚ UIButton ç‚¹å‡»ã€touchesBegin/Move/End/Cancel äº‹ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªå›è°ƒä¸­å®Œæˆçš„ã€‚</p>

<p>å‚è€ƒ:<br/>
<a href="https://blog.ibireme.com/2015/05/18/runloop/">https://blog.ibireme.com/2015/05/18/runloop/</a></p>

<div class="footnotes">
<hr/>
<ol>

<li id="fn1">
<p>Toll-free bridging,ç®€ç§°ä¸ºTFBï¼Œæ˜¯ä¸€ç§å…è®¸æŸäº›ObjCç±»ä¸å…¶å¯¹åº”çš„CoreFoundationç±»ä¹‹é—´å¯ä»¥äº’æ¢ä½¿ç”¨çš„æœºåˆ¶ã€‚æ¯”å¦‚ NSStringä¸CFStringæ˜¯æ¡¥æ¥(bridged)çš„, è¿™æ„å‘³ç€å¯ä»¥å°†ä»»æ„NSStringå½“åšCFStringä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å°†ä»»æ„çš„CFStringå½“åšNSStringä½¿ç”¨&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/01/16</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15788827057157.html">
                
                  <h1>Runtime</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p><img src="media/15788827057157/15788999942773.jpg" alt="" style="width:939px;"/><br/>
Runtime çš„ç‰¹æ€§ä¸»è¦æ˜¯æ¶ˆæ¯ï¼ˆæ–¹æ³•ï¼‰ä¼ é€’ï¼Œå¦‚æœæ¶ˆæ¯ï¼ˆæ–¹æ³•ï¼‰åœ¨å¯¹è±¡ä¸­æ‰¾ä¸åˆ°ï¼Œå°±ä¼šè¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚</p>

<h2 id="toc_0">Runtime ä»‹ç»</h2>

<blockquote>
<p>Objective-C æ‹“å±•äº† Cè¯­è¨€ï¼Œå¹¶ä¸”åŠ å…¥äº†é¢å‘å¯¹è±¡ç‰¹æ€§å’Œ SmallTalk å¼çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œè€Œè¿™ä¸ªæ‹“å±•çš„æ ¸å¿ƒå°±æ˜¯ç”¨ C å’Œç¼–è¯‘è¯­è¨€å†™çš„Runtimeåº“ã€‚Runtimeæ˜¯é¢å‘å¯¹è±¡çš„åŸºç¡€ã€‚</p>
</blockquote>

<p><img src="media/15788827057157/15789003887697.jpg" alt="" style="width:684px;"/></p>

<h2 id="toc_1">Runtime æ¶ˆæ¯ä¼ é€’</h2>

<p>ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•[obj foo]ï¼Œç¼–è¯‘å™¨è½¬æˆæ¶ˆæ¯è½¬å‘ï¼š<strong>objc_msgSend(obj, foo)</strong><br/>
Runtime æ‰§è¡Œçš„æµç¨‹å¦‚ä¸‹ï¼š</p>

<ul>
<li>é¦–å…ˆé€šè¿‡ obj çš„ isa æŒ‡é’ˆï¼Œ æ‰¾åˆ°ä»–çš„ Class</li>
<li>åœ¨ class çš„ methodlistï¼ˆæ–¹æ³•åˆ—è¡¨ï¼‰ åˆ—è¡¨ä¸­æ‰¾æ–¹æ³•ï¼š foo</li>
<li>å¦‚æœ class ä¸­æ²¡æœ‰æ‰¾åˆ° fooï¼Œå°±å‘ä¸Šå»çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­ç»§ç»­æŸ¥æ‰¾ï¼›</li>
<li>å¦‚æœæ‰¾åˆ°äº†å°±æ‰§è¡Œï¼Œå»å®ç° IMPã€‚</li>
</ul>

<p><img src="media/15788827057157/15789011491768.jpg" alt="" style="width:687px;"/><br/>
<img src="media/15788827057157/15789013576022.jpg" alt="" style="width:664px;"/></p>

<ol>
<li>ç³»ç»Ÿé¦–å…ˆæ‰¾åˆ°æ¶ˆæ¯çš„æ¥æ”¶å¯¹è±¡,ç„¶åé€šè¿‡å¯¹è±¡çš„ isa æ‰¾åˆ°ä»–çš„ç±» class.</li>
<li>ç„¶ååœ¨ä»–çš„ç±»ä¸­æŸ¥æ‰¾ method_list,æ˜¯å¦æœ‰ selector æ–¹æ³•</li>
<li>æ²¡æœ‰æ‰¾åˆ°åˆ™ç»§ç»­æŸ¥æ‰¾çˆ¶ç±»çš„ method_list.</li>
<li>æ‰¾åˆ°å¯¹åº”çš„ method,æ‰§è¡Œä»–çš„ IMP</li>
<li>è½¬å‘ IMP çš„ return å€¼.</li>
</ol>

<p>ä¸‹é¢è®²ä¸€ä¸‹æ¶ˆæ¯ä¼ é€’ä¸­ç”¨åˆ°çš„æ¦‚å¿µ:</p>

<ul>
<li>ç±»å¯¹è±¡(objc_class)</li>
<li>å®ä¾‹å¯¹è±¡(objc_object)</li>
<li>å…ƒç±»(Meta Class)</li>
<li>Method(objc_method)</li>
<li>SEL(objc_selector)</li>
<li>IMP</li>
<li>ç±»ç¼“å­˜(objc_cache)</li>
<li>Category(objc_category)</li>
</ul>

<h3 id="toc_2">ç±»å¯¹è±¡(objc_class)</h3>

<p>åœ¨ OC ä¸­ç±»æ˜¯æœ‰ Class ç±»å‹è¡¨ç¤ºçš„,å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡å‘ objc_class çš„ç»“æ„ä½“æŒ‡é’ˆ<br/>
<img src="media/15788827057157/15789018290104.jpg" alt="" style="width:295px;"/><br/>
<img src="media/15788827057157/15789018799631.jpg" alt="" style="width:960px;"/><br/>
struct objc_classç»“æ„ä½“å®šä¹‰äº†å¾ˆå¤šå˜é‡ï¼Œé€šè¿‡å‘½åä¸éš¾å‘ç°ï¼Œ<br/>
ç»“æ„ä½“é‡Œä¿å­˜äº†æŒ‡å‘çˆ¶ç±»çš„æŒ‡é’ˆã€ç±»çš„åå­—ã€ç‰ˆæœ¬ã€å®ä¾‹å¤§å°ã€å®ä¾‹å˜é‡åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨ã€ç¼“å­˜ã€éµå®ˆçš„åè®®åˆ—è¡¨ç­‰ï¼Œ<br/>
ä¸€ä¸ªç±»åŒ…å«çš„ä¿¡æ¯ä¹Ÿä¸å°±æ­£æ˜¯è¿™äº›å—ï¼Ÿæ²¡é”™ï¼Œç±»å¯¹è±¡å°±æ˜¯ä¸€ä¸ªç»“æ„ä½“struct objc_classï¼Œè¿™ä¸ªç»“æ„ä½“å­˜æ”¾çš„æ•°æ®ç§°ä¸ºå…ƒæ•°æ®(metadata)ï¼Œ<br/>
è¯¥ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡ä¹Ÿæ˜¯isaæŒ‡é’ˆï¼Œè¿™å°±è¯´æ˜äº†Classæœ¬èº«å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬ç§°ä¹‹ä¸ºç±»å¯¹è±¡ï¼Œç±»å¯¹è±¡åœ¨ç¼–è¯‘æœŸäº§ç”Ÿç”¨äºåˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œæ˜¯å•ä¾‹ã€‚</p>

<h3 id="toc_3">å®ä¾‹(objc_object)</h3>

<p><img src="media/15788827057157/15789019974820.jpg" alt="" style="width:420px;"/></p>

<p>ç±»å¯¹è±¡ä¸­çš„å…ƒæ•°æ®å­˜å‚¨çš„éƒ½æ˜¯å¦‚ä½•åˆ›å»ºä¸€ä¸ªå®ä¾‹ç›¸å…³çš„ä¿¡æ¯,é‚£ä¹ˆç±»å¯¹è±¡å’Œç±»æ–¹æ³•åº”è¯¥ä»å“ªé‡Œåˆ›å»ºå‘¢? å°±æ˜¯ isa æŒ‡é’ˆæŒ‡å‘çš„ç»“æ„ä½“åˆ›å»º,ç±»å¯¹è±¡çš„ isa æŒ‡é’ˆæŒ‡å‘çš„æˆ‘ä»¬ç§°ä¸ºå…ƒç±»,å…ƒç±»ä¸­ä¿å­˜äº†åˆ›å»ºç±»å¯¹è±¡åŠç±»æ–¹æ³•æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯,æ‰€ä»¥ç»å…¸çš„é‚£å¼ å›¾åˆæ¥äº†:<br/>
<img src="media/15788827057157/15789021597096.jpg" alt="" style="width:934px;"/></p>

<h3 id="toc_4">å…ƒç±»(Meta Class)</h3>

<p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥å‘ç°æ•´ä¸ªä½“ç³»æ„æˆäº†ä¸€ä¸ªè‡ªé—­ç¯, <strong>struct objc_object</strong> çš„ç»“æ„ä½“å®ä¾‹, å®ƒçš„ isa æŒ‡å‘ç±»å¯¹è±¡,ç±»å¯¹è±¡çš„ isa æŒ‡å‘å…ƒç±»,super_class æŒ‡é’ˆæŒ‡å‘çˆ¶ç±»çš„ç±»å¯¹è±¡,è€Œå…ƒç±»çš„ super_class çš„æŒ‡é’ˆæŒ‡å‘äº†çˆ¶ç±»çš„å…ƒç±»,é‚£å…ƒç±»çš„æŒ‡é’ˆåˆæŒ‡å‘äº†è‡ªå·±.<br/>
å…ƒç±»æ˜¯ä¸€ä¸ªç±»å¯¹è±¡çš„ç±»,åœ¨ä¸Šé¢æˆ‘ä»¬æåˆ°æ‰€æœ‰çš„ç±»è‡ªèº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡,æˆ‘ä»¬å¯ä»¥åƒè¿™ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯(è°ƒç”¨æ–¹æ³•),ä¸ºäº†è°ƒç”¨ç±»æ–¹æ³•,è¿™ä¸ªç±»çš„ isa æŒ‡é’ˆå¿…é¡»æŒ‡å‘ä¸€ä¸ªåŒ…å«è¿™äº›ç±»æ–¹æ³•çš„ä¸€ä¸ª objc_class ç»“æ„ä½“,è¿™å°±å¼•å‡ºäº†å…ƒç±»(meta-class)çš„æ¦‚å¿µ.<br/>
å…ƒç±»ä¸­ä¿å­˜äº†åˆ›å»ºç±»å¯¹è±¡ä»¥åŠç±»æ–¹æ³•æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚ ä»»ä½•NSObjectç»§æ‰¿ä½“ç³»ä¸‹çš„meta-classéƒ½ä½¿ç”¨NSObjectçš„meta-classä½œä¸ºè‡ªå·±çš„æ‰€å±ç±»ï¼Œè€Œ<strong>åŸºç±»çš„meta-classçš„isaæŒ‡é’ˆæ˜¯æŒ‡å‘å®ƒè‡ªå·±</strong>ã€‚</p>

<p><img src="media/15788827057157/15789044962794.jpg" alt="" style="width:881px;"/></p>

<ul>
<li>SEL method_name    æ–¹æ³•å</li>
<li>char *method_types æ–¹æ³•ç±»å‹</li>
<li>IMP method_imp     æ–¹æ³•å®ç°</li>
</ul>

<p><img src="media/15788827057157/15789046998441.jpg" alt="" style="width:728px;"/></p>

<p>objc_msgSend å‡½æ•°ç¬¬äºŒä¸ªå‚æ•°ç±»å‹ä¸º SEL.å®ƒæ˜¯ selector åœ¨ OC ä¸­çš„è¡¨ç¤ºç±»å‹(Swift ä¸­æ˜¯ Selector ç±»).selector æ˜¯æ–¹æ³•é€‰æ‹©å™¨,å¯ä»¥ç†è§£ä¸ºåŒºåˆ†æ–¹æ³•çš„ ID,è€Œè¿™ä¸ª ID çš„æ•°æ®ç»“æ„æ˜¯ SEL.<br/>
<img src="media/15788827057157/15789049888500.jpg" alt="" style="width:972px;"/></p>

<p><img src="media/15788827057157/15789050086371.jpg" alt="" style="width:988px;"/></p>

<p><img src="media/15788827057157/15789060707679.jpg" alt="" style="width:978px;"/></p>

<p><img src="media/15788827057157/15789062512658.jpg" alt="" style="width:547px;"/></p>

<ul>
<li>name:æ˜¯æŒ‡ class_name è€Œä¸æ˜¯ category_nameã€‚</li>
<li>cls:è¦æ‰©å±•çš„ç±»å¯¹è±¡ï¼Œç¼–è¯‘æœŸé—´æ˜¯ä¸ä¼šå®šä¹‰çš„ï¼Œè€Œæ˜¯åœ¨Runtimeé˜¶æ®µé€šè¿‡nameå¯¹ åº”åˆ°å¯¹åº”çš„ç±»å¯¹è±¡ã€‚</li>
<li>instanceMethodsï¼šcategoryä¸­æ‰€æœ‰ç»™ç±»æ·»åŠ çš„å®ä¾‹æ–¹æ³•çš„åˆ—è¡¨ã€‚</li>
<li>classMethodsï¼šcategoryä¸­æ‰€æœ‰æ·»åŠ çš„ç±»æ–¹æ³•çš„åˆ—è¡¨ã€‚</li>
<li>protocolsï¼šcategoryå®ç°çš„æ‰€æœ‰åè®®çš„åˆ—è¡¨ã€‚</li>
<li>instancePropertiesï¼šè¡¨ç¤ºCategoryé‡Œæ‰€æœ‰çš„propertiesï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡objc_setAssociatedObjectå’Œobjc_getAssociatedObjectå¢åŠ å®ä¾‹å˜é‡çš„åŸå› ï¼Œä¸è¿‡è¿™ä¸ªå’Œä¸€èˆ¬çš„å®ä¾‹å˜é‡æ˜¯ä¸ä¸€æ ·çš„ã€‚</li>
</ul>

<p><img src="media/15788827057157/15789063762697.jpg" alt="" style="width:983px;"/></p>

<h2 id="toc_5">Runtime æ¶ˆæ¯è½¬å‘</h2>

<p>æ¶ˆæ¯è½¬å‘çš„æœ€åä¸‰æ¬¡æœºä¼š</p>

<ul>
<li>åŠ¨æ€æ–¹æ³•è§£æ</li>
<li>å¤‡ç”¨æ¥å—è€…</li>
<li>å®Œæ•´æ¶ˆæ¯è½¬å‘</li>
</ul>

<p><img src="media/15788827057157/15789064378501.jpg" alt="" style="width:974px;"/></p>

<h3 id="toc_6">åŠ¨æ€æ–¹æ³•è§£æ</h3>

<p><img src="media/15788827057157/15789066286973.jpg" alt="" style="width:964px;"/></p>

<p>å¯ä»¥çœ‹åˆ°è™½ç„¶æ²¡æœ‰å®ç°foo:è¿™ä¸ªå‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬é€šè¿‡class_addMethodåŠ¨æ€æ·»åŠ fooMethodå‡½æ•°ï¼Œå¹¶æ‰§è¡ŒfooMethodè¿™ä¸ªå‡½æ•°çš„IMPã€‚ä»æ‰“å°ç»“æœçœ‹ï¼ŒæˆåŠŸå®ç°äº†ã€‚<br/>
å¦‚æœresolveæ–¹æ³•è¿”å› NO ï¼Œè¿è¡Œæ—¶å°±ä¼šç§»åˆ°ä¸‹ä¸€æ­¥ï¼š<strong>forwardingTargetForSelector</strong>ã€‚</p>

<h3 id="toc_7">å¤‡ç”¨æ¥å—è€…</h3>

<p>å¦‚æœç›®æ ‡å¯¹è±¡å®ç°äº†<strong>-forwardingTargetForSelector:</strong>ï¼ŒRuntime è¿™æ—¶å°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œç»™ä½ æŠŠè¿™ä¸ªæ¶ˆæ¯è½¬å‘ç»™å…¶ä»–å¯¹è±¡çš„æœºä¼šã€‚</p>

<p>å®ç°ä¸€ä¸ªå¤‡ç”¨æ¥æ”¶è€…çš„ä¾‹å­å¦‚ä¸‹ï¼š</p>

<p><img src="media/15788827057157/15789068795712.jpg" alt="" style="width:667px;"/><br/>
å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡forwardingTargetForSelectoræŠŠå½“å‰ViewControllerçš„æ–¹æ³•è½¬å‘ç»™äº†Personå»æ‰§è¡Œäº†ã€‚æ‰“å°ç»“æœä¹Ÿè¯æ˜æˆ‘ä»¬æˆåŠŸå®ç°äº†è½¬å‘ã€‚</p>

<h3 id="toc_8">å®Œæ•´æ¶ˆæ¯è½¬å‘</h3>

<p>å¦‚æœåœ¨ä¸Šä¸€æ­¥è¿˜ä¸èƒ½å¤„ç†æœªçŸ¥æ¶ˆæ¯ï¼Œåˆ™å”¯ä¸€èƒ½åšçš„å°±æ˜¯å¯ç”¨å®Œæ•´çš„æ¶ˆæ¯è½¬å‘æœºåˆ¶äº†ã€‚<br/>
é¦–å…ˆå®ƒä¼šå‘é€<strong>-methodSignatureForSelector:</strong>æ¶ˆæ¯è·å¾—å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ã€‚å¦‚æœ-<strong>methodSignatureForSelector:</strong>è¿”å›nil ï¼ŒRuntimeåˆ™ä¼šå‘å‡º <strong>-doesNotRecognizeSelector:</strong> æ¶ˆæ¯ï¼Œç¨‹åºè¿™æ—¶ä¹Ÿå°±æŒ‚æ‰äº†ã€‚å¦‚æœè¿”å›äº†ä¸€ä¸ªå‡½æ•°ç­¾åï¼ŒRuntimeå°±ä¼šåˆ›å»ºä¸€ä¸ª<strong>NSInvocation</strong> å¯¹è±¡å¹¶å‘é€ <strong>-forwardInvocation:</strong>æ¶ˆæ¯ç»™ç›®æ ‡å¯¹è±¡ã€‚</p>

<p><img src="media/15788827057157/15789070035039.jpg" alt="" style="width:765px;"/><br/>
<img src="media/15788827057157/15789070187925.jpg" alt="" style="width:774px;"/><br/>
ä»æ‰“å°ç»“æœæ¥çœ‹ï¼Œæˆ‘ä»¬å®ç°äº†å®Œæ•´çš„è½¬å‘ã€‚é€šè¿‡ç­¾åï¼ŒRuntimeç”Ÿæˆäº†ä¸€ä¸ªå¯¹è±¡anInvocationï¼Œå‘é€ç»™äº†forwardInvocationï¼Œæˆ‘ä»¬åœ¨forwardInvocationæ–¹æ³•é‡Œé¢è®©Personå¯¹è±¡å»æ‰§è¡Œäº†fooå‡½æ•°ã€‚ç­¾åå‚æ•°v@:æ€ä¹ˆè§£é‡Šå‘¢ï¼Œè¿™é‡Œè‹¹æœæ–‡æ¡£Type Encodingsæœ‰è¯¦ç»†çš„è§£é‡Šã€‚<br/>
ä»¥ä¸Šå°±æ˜¯Runtimeçš„ä¸‰æ¬¡è½¬å‘æµç¨‹ã€‚ä¸‹é¢æˆ‘ä»¬è®²è®²Runtimeçš„å®é™…åº”ç”¨ã€‚<br/>
<img src="media/15788827057157/15789072653201.jpg" alt="" style="width:987px;"/></p>

<h2 id="toc_9">Runtime åº”ç”¨</h2>

<ul>
<li>AOP é¢å‘åˆ‡ç‰‡ç¼–ç¨‹(åŸ‹ç‚¹æ–¹é¢ç”¨çš„æ¯”è¾ƒå¤š)
<img src="media/15788827057157/15789071021461.jpg" alt="" style="width:702px;"/>
<img src="media/15788827057157/15789071215521.jpg" alt="" style="width:811px;"/></li>
</ul>

<p>ä¸‹é¢å®ç°ä¸€ä¸ªUIViewçš„Categoryæ·»åŠ è‡ªå®šä¹‰å±æ€§defaultColorã€‚<br/>
<img src="media/15788827057157/15789080004602.jpg" alt="" style="width:839px;"/><br/>
<img src="media/15788827057157/15789080309274.jpg" alt="" style="width:969px;"/></p>

<p><img src="media/15788827057157/15789079081069.jpg" alt="" style="width:961px;"/><br/>
<strong><em>æ³¨:weak çš„å…³è”å†…å­˜ç®¡ç†ç­–ç•¥æ˜¯ä»€ä¹ˆ?</em></strong><br/>
<a href="https://dayon.gitbooks.io/-ios/content/chapter8.html">https://dayon.gitbooks.io/-ios/content/chapter8.html</a></p>

<h3 id="toc_10">æ–¹æ³•æ·»åŠ </h3>

<p><img src="media/15788827057157/15789083218769.jpg" alt="" style="width:943px;"/></p>

<h3 id="toc_11">æ–¹æ³•æ›¿æ¢</h3>

<p>ä¸‹é¢å®ç°ä¸€ä¸ªæ›¿æ¢ViewControllerçš„viewDidLoadæ–¹æ³•çš„ä¾‹å­ã€‚<br/>
<img src="media/15788827057157/15789085581682.jpg" alt="" style="width:1074px;"/><br/>
swizzlingåº”è¯¥åªåœ¨+loadä¸­å®Œæˆã€‚ åœ¨ Objective-C çš„è¿è¡Œæ—¶ä¸­ï¼Œæ¯ä¸ªç±»æœ‰ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚+load æ˜¯åœ¨ä¸€ä¸ªç±»è¢«åˆå§‹è£…è½½æ—¶è°ƒç”¨ï¼Œ+initialize æ˜¯åœ¨åº”ç”¨ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥ç±»çš„ç±»æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•å‰è°ƒç”¨çš„ã€‚ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯å¯é€‰çš„ï¼Œå¹¶ä¸”åªæœ‰åœ¨æ–¹æ³•è¢«å®ç°çš„æƒ…å†µä¸‹æ‰ä¼šè¢«è°ƒç”¨ã€‚<br/>
swizzlingåº”è¯¥åªåœ¨dispatch_once ä¸­å®Œæˆ,ç”±äºswizzling æ”¹å˜äº†å…¨å±€çš„çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¡®ä¿æ¯ä¸ªé¢„é˜²æªæ–½åœ¨è¿è¡Œæ—¶éƒ½æ˜¯å¯ç”¨çš„ã€‚åŸå­æ“ä½œå°±æ˜¯è¿™æ ·ä¸€ä¸ªç”¨äºç¡®ä¿ä»£ç åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡çš„é¢„é˜²æªæ–½ï¼Œå°±ç®—æ˜¯åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ä¹Ÿèƒ½ç¡®ä¿ä»£ç åªæ‰§è¡Œä¸€æ¬¡ã€‚Grand Central Dispatch çš„ dispatch_onceæ»¡è¶³äº†æ‰€éœ€è¦çš„éœ€æ±‚ï¼Œå¹¶ä¸”åº”è¯¥è¢«å½“åšä½¿ç”¨swizzling çš„åˆå§‹åŒ–å•ä¾‹æ–¹æ³•çš„æ ‡å‡†ã€‚</p>

<h3 id="toc_12">KVOå®ç°</h3>

<p><img src="media/15788827057157/15789086448973.jpg" alt="" style="width:924px;"/><br/>
<img src="media/15788827057157/15789086852696.jpg" alt="" style="width:941px;"/><br/>
<img src="media/15788827057157/15789087796562.jpg" alt="" style="width:950px;"/></p>

<p>æ³¨:<br/>
æ¶ˆæ¯è½¬å‘ä¸­&quot;v@:&quot;å«ä¹‰:<br/>
<img src="media/15788827057157/15789066840487.jpg" alt="" style="width:712px;"/></p>

<p>å‚è€ƒï¼š<br/>
<a href="https://juejin.im/post/5ac0a6116fb9a028de44d717">https://juejin.im/post/5ac0a6116fb9a028de44d717</a><br/>
<a href="https://bujige.net/blog/iOS-Runtime-01.html">https://bujige.net/blog/iOS-Runtime-01.html</a><br/>
<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100">https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html#//apple_ref/doc/uid/TP40008048-CH100</a><br/>
<a href="https://www.jianshu.com/p/ab966e8a82e2">https://www.jianshu.com/p/ab966e8a82e2</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/01/13</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15786431485871.html">
                
                  <h1>KVO && KVC å®ç°åŸç†</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p><img src="media/15786431485871/15786484212119.jpg" alt="" style="width:643px;"/></p>

<h2 id="toc_0">ä¸€ã€ä»€ä¹ˆæ˜¯ KVOï¼Ÿï¼ˆKey-VauleObservingï¼‰</h2>

<p>KVO æ˜¯ OC å¯¹è§‚å¯Ÿè€…æ¨¡å¼çš„å®ç°ï¼Œä¹Ÿæ˜¯ CocoaBinding çš„åŸºç¡€ï¼Œå½“è¢«è§‚å¯Ÿçš„å¯¹è±¡çš„æŸä¸ªå±æ€§å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œè§‚å¯Ÿè€…å¯¹è±¡å°±ä¼šè·å¾—é€šçŸ¥</p>

<p>é¢è¯•é¢˜ï¼š</p>

<blockquote>
<p>addObserver:forKeyPath:options:context:å„ä¸ªå‚æ•°çš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ, observerä¸­éœ€è¦å®ç°å“ªä¸ªæ–¹æ³•æ‰èƒ½è·å¾—KVOå›è°ƒï¼Ÿ</p>
</blockquote>

<pre class="line-numbers"><code class="language-text">**
 1. self.personï¼šè¦ç›‘å¬çš„å¯¹è±¡
 2. å‚æ•°è¯´æ˜ï¼š
    * @param addObserver  è§‚å¯Ÿè€…ï¼Œè´Ÿè´£å¤„ç†ç›‘å¬äº‹ä»¶çš„å¯¹è±¡
    * @param forKeyPath è¦ç›‘å¬çš„å±æ€§
    * @param  options è§‚å¯Ÿçš„é€‰é¡¹ï¼ˆè§‚å¯Ÿæ–°ã€æ—§å€¼ï¼Œä¹Ÿå¯ä»¥éƒ½è§‚å¯Ÿï¼‰
    * @param context ä¸Šä¸‹æ–‡ï¼Œç”¨äºä¼ é€’æ•°æ®ï¼Œå¯ä»¥åˆ©ç”¨ä¸Šä¸‹æ–‡åŒºåˆ†ä¸åŒçš„ç›‘å¬
 */
[self.person addObserver:self 
              forKeyPath:@&quot;name&quot; 
                 options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld 
                 context:@&quot;Person Name&quot;];

/**
 *  å½“ç›‘æ§çš„æŸä¸ªå±æ€§çš„å€¼æ”¹å˜äº†å°±ä¼šè°ƒç”¨
 *
 *  @param keyPath ç›‘å¬çš„å±æ€§å
 *  @param object  å±æ€§æ‰€å±çš„å¯¹è±¡
 *  @param change  å±æ€§çš„ä¿®æ”¹æƒ…å†µï¼ˆå±æ€§åŸæ¥çš„å€¼`oldValue`ã€å±æ€§æœ€æ–°çš„å€¼`newValue`ï¼‰
 *  @param context ä¼ é€’çš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œä¸ç›‘å¬çš„æ—¶å€™ä¼ é€’çš„ä¸€è‡´ï¼Œå¯ä»¥åˆ©ç”¨ä¸Šä¸‹æ–‡åŒºåˆ†ä¸åŒçš„ç›‘å¬
 */
- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context
{
    NSLog(@&quot;%@å¯¹è±¡çš„%@å±æ€§æ”¹å˜äº†ï¼š%@&quot;, object, keyPath, change);
}
</code></pre>

<h2 id="toc_1">äºŒã€KVO å†…éƒ¨å®ç°åŸç†</h2>

<p>å®˜æ–¹æ–‡æ¡£çš„è¯´æ³•ï¼š</p>

<blockquote>
<p>Automatic key-value observing is implemented using a technique called isa-swizzling.<br/>
KVOä½¿ç”¨äº†åä¸ºisa-swizzlingçš„æŠ€æœ¯</p>

<p>The isa pointer, as the name suggests, points to the object&#39;s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.<br/>
isaæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„ç±»,è¿™ä¸ªç±»åŒ…å«äº†ä¸€ä¸ªæ–¹æ³•æ´¾å‘è¡¨</p>

<p>When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.<br/>
è¢«è§‚å¯Ÿå¯¹è±¡çš„isaæŒ‡é’ˆä¼šè¢«ä¿®æ”¹,æŒ‡å‘ä¸€ä¸ªä¸­é—´ç±»,è€ŒéçœŸå®çš„ç±».isaæŒ‡é’ˆçš„å€¼å¹¶ä¸å¿…é¡»ååº”å®ä¾‹å¯¹è±¡çš„çœŸå®å¯¹åº”çš„ç±»</p>

<p>You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.<br/>
å› è€Œ,åº”è¯¥è°ƒç”¨å¯¹è±¡çš„classæ–¹æ³•æ¥ç¡®å®šå®ä¾‹å¯¹åº”çš„ç±»è€Œä¸æ˜¯isaæŒ‡é’ˆçš„å€¼</p>
</blockquote>

<ol>
<li><p>KVO æ˜¯åŸºäº runtime æœºåˆ¶å®ç°çš„ã€‚</p>
<blockquote>
<p>KVO è¿ç”¨äº†ä¸€ä¸ª isa-swizzling æŠ€æœ¯ï¼ˆç±»å‹æ··åˆæŒ‡é’ˆæœºåˆ¶ï¼‰ï¼Œå°†ä¸¤ä¸ªå¯¹è±¡çš„ isa æŒ‡é’ˆäº’ç›¸è°ƒæ¢ï¼Œå°±æ˜¯ä¿—ç§°çš„é»‘é­”æ³•ã€‚</p>
</blockquote></li>
<li><p>å½“æŸä¸ªç±»çš„å¯¹è±¡ <strong><u><em>ç¬¬ä¸€æ¬¡è¢«è§‚å¯Ÿ</em></u></strong> çš„æ—¶å€™ï¼Œç³»ç»Ÿå°±ä¼šåœ¨è¿è¡ŒæœŸ<strong><u><em>åŠ¨æ€çš„åˆ›å»ºè¯¥ç±»çš„ä¸€ä¸ªæ´¾ç”Ÿç±»</em></u></strong>ï¼Œ åœ¨è¿™ä¸ªæ´¾ç”Ÿç±»ä¸­é‡å†™åŸºç±»ä¸­ä»»ä½•è¢«è§‚å¯Ÿå±æ€§çš„ setter æ–¹æ³•ï¼Œæ´¾ç”Ÿç±»åœ¨è¢«é‡å†™çš„ setter æ–¹æ³•å†…éƒ¨å®ç°çœŸæ­£çš„é€šçŸ¥æœºåˆ¶ã€‚</p>
<blockquote>
<p>å¦‚æœåŸç±»ä¸ºPersonï¼Œé‚£ä¹ˆç”Ÿæˆçš„æ´¾ç”Ÿç±»åä¸ºNSKVONotifying_Person</p>
</blockquote></li>
<li><p>æ¯ä¸ªç±»å¯¹è±¡ä¸­éƒ½æœ‰ä¸€ä¸ªisa æŒ‡é’ˆæŒ‡å‘å½“å‰ç±»ï¼Œå½“ä¸€ä¸ªç±»å¯¹è±¡çš„å±æ€§ç¬¬ä¸€æ¬¡è¢«è§‚å¯Ÿï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¼šå°† isa æŒ‡é’ˆæŒ‡å‘åŠ¨æ€ç”Ÿæˆçš„æ´¾ç”Ÿç±»ï¼Œä»è€Œåœ¨ç»™è¢«ç›‘æ§çš„å±æ€§èµ‹å€¼çš„æ—¶å€™æ‰§è¡Œçš„æ˜¯æ´¾ç”Ÿç±»çš„ setter æ–¹æ³•ã€‚</p></li>
<li><p>é”®å€¼è§‚å¯Ÿé€šçŸ¥ï¼ˆKVOï¼‰ä¾èµ–äº NSObject çš„ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<blockquote>
<p>willChangeValueForKey: å’Œ didChangevlueForKeyï¼š<br/>
å½“ä¸€ä¸ªè¢«è§‚å¯Ÿçš„å±æ€§å‘ç”Ÿæ”¹å˜ä¹‹å‰ï¼ŒwillChangeValueForKeyï¼š ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œè¿™å°±ä¼šè®°å½•æ—§å€¼ï¼Œå½“å‘ç”Ÿæ”¹å˜ä¹‹åï¼ŒdidChangevlueForKeyï¼šä¼šè¢«è°ƒç”¨ï¼Œç»§è€ŒobserveValueForKey:ofObject:change:context: ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚</p>
</blockquote></li>
</ol>

<blockquote>
<p>KVO çš„è¿™å¥—å®ç°æœºåˆ¶ä¸­ï¼Œè‹¹æœè¿˜å·å·å®ç°äº† class æ–¹æ³•ï¼Œè®©æˆ‘ä»¬è¯¯ä»¥ä¸ºä½¿ç”¨çš„è¿˜æ˜¯å½“å‰çš„ç±»ï¼Œä»è€Œè¾¾åˆ°éšè—æ´¾ç”Ÿç±»çš„ç›®çš„<br/>
<img src="media/15786431485871/15786460750917.jpg" alt="" style="width:926px;"/></p>
</blockquote>

<h2 id="toc_2">ä¸‰ï¼Œå¦‚ä½•æ‰‹åŠ¨è§¦å‘ KVO</h2>

<p>æ‰‹åŠ¨è§¦å‘ KVO å¿…é¡»å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼š<br/>
willChangeValueForKey:å’ŒdidChangeValueForKey:</p>

<ul>
<li>å¦‚ä½•è‡ªå·±åŠ¨æ‰‹å®ç° KVOï¼Ÿ<br/>
1ï¼ŒBlock æ¨¡æ‹Ÿå®ç° KVO<br/>
å¤§ä½“æ­¥éª¤ï¼š<br/>
    1ï¼Œåˆ›å»º NSObject çš„åˆ†ç±»ï¼Œå¢åŠ æ·»åŠ è§‚å¯Ÿè€…çš„ APIï¼Œå¹¶å®ç°</li>
</ul>

<pre class="line-numbers"><code class="language-text">- (void)PG_addObserver:(NSObject *)observer
                forKey:(NSString *)key
             withBlock:(PGObservingBlock)block {
    //æ£€æŸ¥å¯¹è±¡çš„ç±»æœ‰æ²¡æœ‰ç›¸åº”çš„ setter æ–¹æ³•ã€‚å¦‚æœæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼›
    SEL setterSelector = NSSelectorFromString(setterForGetter(key));
    Method setterMethod = class_getInstanceMethod([self class], setterSelector);
    if (!setterMethod) {
        // throw invalid argument exception
    }
 
    Class clazz = object_getClass(self);
    NSString *clazzName = NSStringFromClass(clazz);
 
    // æ£€æŸ¥å¯¹è±¡ isa æŒ‡å‘çš„ç±»æ˜¯ä¸æ˜¯ä¸€ä¸ª KVO ç±»ã€‚å¦‚æœä¸æ˜¯ï¼Œæ–°å»ºä¸€ä¸ªç»§æ‰¿åŸæ¥ç±»çš„å­ç±»ï¼Œå¹¶æŠŠ isa æŒ‡å‘è¿™ä¸ªæ–°å»ºçš„å­ç±»ï¼›
    if (![clazzName hasPrefix:kPGKVOClassPrefix]) {
        clazz = [self makeKvoClassWithOriginalClassName:clazzName];
        object_setClass(self, clazz);
    }
 
    // æ£€æŸ¥å¯¹è±¡çš„ KVO ç±»é‡å†™è¿‡æ²¡æœ‰è¿™ä¸ª setter æ–¹æ³•ã€‚å¦‚æœæ²¡æœ‰ï¼Œæ·»åŠ é‡å†™çš„ setter æ–¹æ³•ï¼›
    //          hasn&#39;t implemented the setter
    if (![self hasSelector:setterSelector]) {
        const char *types = method_getTypeEncoding(setterMethod);
        class_addMethod(clazz, setterSelector, (IMP)kvo_setter, types);
    }
 
    // æ·»åŠ è¿™ä¸ªè§‚å¯Ÿè€…
    PGObservationInfo *info = [[PGObservationInfo alloc] initWithObserver:observer Key:key block:block];
    NSMutableArray *observers = objc_getAssociatedObject(self, (__bridge const void *)(kPGKVOAssociatedObservers));
    if (!observers) {
        observers = [NSMutableArray array];
        objc_setAssociatedObject(self, (__bridge const void *)(kPGKVOAssociatedObservers), observers, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
    }
    [observers addObject:info];
}

</code></pre>

<p>å†æ¥ä¸€æ­¥ä¸€æ­¥ç»†çœ‹ã€‚<br/>
ç¬¬ä¸€æ­¥é‡Œï¼Œå…ˆé€šè¿‡ setterForGetter() æ–¹æ³•è·å¾—ç›¸åº”çš„ setter çš„åå­—ï¼ˆSELï¼‰ã€‚ä¹Ÿå°±æ˜¯æŠŠ key çš„é¦–å­—æ¯å¤§å†™ï¼Œç„¶åå‰é¢åŠ ä¸Š set åé¢åŠ ä¸Š :ï¼Œè¿™æ · key å°±å˜æˆäº† setKey:ã€‚ç„¶åå†ç”¨ class_getInstanceMethod å»è·å¾— setKey: çš„å®ç°ï¼ˆMethodï¼‰ã€‚å¦‚æœæ²¡æœ‰ï¼Œè‡ªç„¶è¦æŠ›å‡ºå¼‚å¸¸ã€‚</p>

<p>ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬å…ˆçœ‹ç±»åæœ‰æ²¡æœ‰æˆ‘ä»¬å®šä¹‰çš„å‰ç¼€ã€‚å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬å°±å»åˆ›å»ºæ–°çš„å­ç±»ï¼Œå¹¶é€šè¿‡ object_setClass() ä¿®æ”¹ isa æŒ‡é’ˆã€‚</p>

<pre class="line-numbers"><code class="language-text">- (Class)makeKvoClassWithOriginalClassName:(NSString *)originalClazzName {
    NSString *kvoClazzName = [kPGKVOClassPrefix stringByAppendingString:originalClazzName];
    Class clazz = NSClassFromString(kvoClazzName);
 
    if (clazz) {
        return clazz;
    }
 
    // class doesn&#39;t exist yet, make it
    Class originalClazz = object_getClass(self);
    Class kvoClazz = objc_allocateClassPair(originalClazz, kvoClazzName.UTF8String, 0);
 
    // grab class method&#39;s signature so we can borrow it
    Method clazzMethod = class_getInstanceMethod(originalClazz, @selector(class));
    const char *types = method_getTypeEncoding(clazzMethod);
    class_addMethod(kvoClazz, @selector(class), (IMP)kvo_class, types);
 
    objc_registerClassPair(kvoClazz);
 
    return kvoClazz;
}
</code></pre>

<p>åŠ¨æ€åˆ›å»ºæ–°çš„ç±»éœ€è¦ç”¨ objc/runtime.h ä¸­å®šä¹‰çš„ objc_allocateClassPair() å‡½æ•°ã€‚ä¼ ä¸€ä¸ªçˆ¶ç±»ï¼Œç±»åï¼Œç„¶åé¢å¤–çš„ç©ºé—´ï¼ˆé€šå¸¸ä¸º 0ï¼‰ï¼Œå®ƒè¿”å›ç»™ä½ ä¸€ä¸ªç±»ã€‚ç„¶åå°±ç»™è¿™ä¸ªç±»æ·»åŠ æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ·»åŠ å˜é‡ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬åªé‡å†™äº† class æ–¹æ³•ã€‚å“ˆå“ˆï¼Œè·Ÿ Apple ä¸€æ ·ï¼Œè¿™æ—¶å€™æˆ‘ä»¬ä¹Ÿä¼å›¾éšè—è¿™ä¸ªå­ç±»çš„å­˜åœ¨ã€‚æœ€å objc_registerClassPair() å‘Šè¯‰ Runtime è¿™ä¸ªç±»çš„å­˜åœ¨ã€‚</p>

<p>ç¬¬ä¸‰æ­¥ï¼Œé‡å†™ setter æ–¹æ³•ã€‚æ–°çš„ setter åœ¨è°ƒç”¨åŸ setter æ–¹æ³•åï¼Œé€šçŸ¥æ¯ä¸ªè§‚å¯Ÿè€…ï¼ˆè°ƒç”¨ä¹‹å‰ä¼ å…¥çš„ block ï¼‰ï¼š</p>

<pre class="line-numbers"><code class="language-text">static void kvo_setter(id self, SEL _cmd, id newValue)  
{
    NSString *setterName = NSStringFromSelector(_cmd);
    NSString *getterName = getterForSetter(setterName);
 
    if (!getterName) {
        // throw invalid argument exception
    }
 
    id oldValue = [self valueForKey:getterName];
 
    struct objc_super superclazz = {
        .receiver = self,
        .super_class = class_getSuperclass(object_getClass(self))
    };
 
    // cast our pointer so the compiler won&#39;t complain
    void (*objc_msgSendSuperCasted)(void *, SEL, id) = (void *)objc_msgSendSuper;
 
    // call super&#39;s setter, which is original class&#39;s setter method
    objc_msgSendSuperCasted(&amp;superclazz, _cmd, newValue);
 
    // look up observers and call the blocks
    NSMutableArray *observers = objc_getAssociatedObject(self, (__bridge const void *)(kPGKVOAssociatedObservers));
    for (PGObservationInfo *each in observers) {
        if ([each.key isEqualToString:getterName]) {
            dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
                each.block(self, getterName, oldValue, newValue);
            });
        }
    }
}
</code></pre>

<p>ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°æˆ‘ä»¬å¯¹ objc_msgSendSuper è¿›è¡Œç±»å‹è½¬æ¢ã€‚åœ¨ Xcode 6 é‡Œï¼Œæ–°çš„ LLVM ä¼šå¯¹ objc_msgSendSuper ä»¥åŠ objc_msgSend åšä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥ï¼Œå¦‚æœä¸åšç±»å‹è½¬æ¢ã€‚Xcode ä¼šæŠ±æ€¨æœ‰ too many arguments çš„é”™è¯¯ã€‚ï¼ˆåœ¨ WWDC 2014 çš„è§†é¢‘ What new in LLVM ä¸­æœ‰æåˆ°è¿‡è¿™ä¸ªé—®é¢˜ã€‚ï¼‰</p>

<p>æœ€åä¸€æ­¥ï¼ŒæŠŠè¿™ä¸ªè§‚å¯Ÿçš„ç›¸å…³ä¿¡æ¯å­˜åœ¨ associatedObject é‡Œã€‚è§‚å¯Ÿçš„ç›¸å…³ä¿¡æ¯ï¼ˆè§‚å¯Ÿè€…ï¼Œè¢«è§‚å¯Ÿçš„ key, å’Œä¼ å…¥çš„ block ï¼‰å°è£…åœ¨ PGObservationInfo ç±»é‡Œã€‚</p>

<pre class="line-numbers"><code class="language-text">@interface PGObservationInfo : NSObject
 
@property (nonatomic, weak) NSObject *observer;
@property (nonatomic, copy) NSString *key;
@property (nonatomic, copy) PGObservingBlock block;
 
@end
</code></pre>

<p>å°±æ­¤ï¼Œä¸€ä¸ªåŸºæœ¬çš„ KVO å°±å¯ä»¥ work äº†ã€‚å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªä¸€å¤©å¤šåšå‡ºæ¥çš„å°ä¸œè¥¿ï¼Œä¼šæœ‰ bugï¼Œä¹Ÿæœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–å®Œå–„çš„åœ°æ–¹ã€‚ä½†ä½œä¸º demo æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨ Runtime åŠ¨æ€åˆ›å»ºç±»ã€å¦‚ä½•å®ç° KVOï¼Œè¶³å·²ã€‚</p>

<ul>
<li>KVO ä½¿ç”¨æ³¨æ„ç‚¹<br/>
è‹¹æœæä¾›çš„KVOè‡ªèº«å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼Œé¦–è¦é—®é¢˜åœ¨äºï¼ŒKVOå¦‚æœä½¿ç”¨ä¸å½“å¾ˆå®¹æ˜“å´©æºƒã€‚ä¾‹å¦‚é‡å¤addå’Œremoveå¯¼è‡´çš„Crashï¼ŒObserverè¢«é‡Šæ”¾å¯¼è‡´çš„å´©æºƒï¼ŒkeyPathä¼ é”™å¯¼è‡´çš„å´©æºƒç­‰ã€‚</li>
</ul>

<p>åœ¨è°ƒç”¨KVOæ—¶éœ€è¦ä¼ å…¥ä¸€ä¸ªkeyPathï¼Œç”±äºkeyPathæ˜¯å­—ç¬¦ä¸²çš„å½¢å¼ï¼Œæ‰€ä»¥å…¶å¯¹åº”çš„å±æ€§å‘ç”Ÿæ”¹å˜åï¼Œå­—ç¬¦ä¸²æ²¡æœ‰æ”¹å˜å®¹æ˜“å¯¼è‡´Crashã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç³»ç»Ÿçš„åå°„æœºåˆ¶å°†keyPathåå°„å‡ºæ¥ï¼Œè¿™æ ·ç¼–è¯‘å™¨å¯ä»¥åœ¨@selector()ä¸­è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥ã€‚<br/>
KVOæ˜¯ä¸€ç§äº‹ä»¶ç»‘å®šæœºåˆ¶çš„å®ç°ï¼Œåœ¨keyPathå¯¹åº”çš„å€¼å‘ç”Ÿæ”¹å˜åä¼šå›è°ƒå¯¹åº”çš„æ–¹æ³•ã€‚è¿™ç§æ•°æ®ç»‘å®šæœºåˆ¶ï¼Œåœ¨å¯¹è±¡å…³ç³»å¾ˆå¤æ‚çš„æƒ…å†µä¸‹ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ä¸å¥½æ’æŸ¥çš„bugã€‚ä¾‹å¦‚keyPathå¯¹åº”çš„å±æ€§è¢«è°ƒç”¨çš„å…³ç³»å¾ˆå¤æ‚ï¼Œå°±ä¸å¤ªå»ºè®®å¯¹è¿™ä¸ªå±æ€§è¿›è¡ŒKVOï¼Œå¯ä»¥æƒ³ä¸€ä¸‹RACçš„ä¿¡å·è„‘è¡¥ä¸€ä¸‹ã€‚</p>

<h2 id="toc_3">KVC æ˜¯ä»€ä¹ˆ</h2>

<blockquote>
<p>KVCï¼ˆKey-value codingï¼‰é”®å€¼ç¼–ç ï¼Œå°±æ˜¯æŒ‡iOSçš„å¼€å‘ä¸­ï¼Œå¯ä»¥å…è®¸å¼€å‘è€…é€šè¿‡Keyåç›´æ¥è®¿é—®å¯¹è±¡çš„å±æ€§ï¼Œæˆ–è€…ç»™å¯¹è±¡çš„å±æ€§èµ‹å€¼ã€‚è€Œä¸éœ€è¦è°ƒç”¨æ˜ç¡®çš„å­˜å–æ–¹æ³•ã€‚è¿™æ ·å°±å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è®¿é—®å’Œä¿®æ”¹å¯¹è±¡çš„å±æ€§ã€‚è€Œä¸æ˜¯åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œè¿™ä¹Ÿæ˜¯iOSå¼€å‘ä¸­çš„é»‘é­”æ³•ä¹‹ä¸€ã€‚å¾ˆå¤šé«˜çº§çš„iOSå¼€å‘æŠ€å·§éƒ½æ˜¯åŸºäºKVCå®ç°çš„ã€‚</p>
</blockquote>

<p>KVCæœ€ä¸ºé‡è¦çš„å››ä¸ªæ–¹æ³•ï¼š</p>

<pre class="line-numbers"><code class="language-text">- (nullable id)valueForKey:(NSString *)key;                          //ç›´æ¥é€šè¿‡Keyæ¥å–å€¼

- (void)setValue:(nullable id)value forKey:(NSString *)key;          //é€šè¿‡Keyæ¥è®¾å€¼

- (nullable id)valueForKeyPath:(NSString *)keyPath;                  //é€šè¿‡KeyPathæ¥å–å€¼

- (void)setValue:(nullable id)value forKeyPath:(NSString *)keyPath;  //é€šè¿‡KeyPathæ¥è®¾å€¼
</code></pre>

<h2 id="toc_4">isa æŒ‡é’ˆæ˜¯ä»€ä¹ˆç±»å‹çš„ï¼Ÿ</h2>

<p>runtime ä¸­ï¼Œclass å’Œ object çš„å®šä¹‰ï¼š</p>

<pre class="line-numbers"><code class="language-text">typedef struct objc_class *Class;
typedef struct objc_object {
    Class isa;
} *id;
</code></pre>

<p>Class æ˜¯ä¸€ä¸ª objc_class ç»“æ„ç±»å‹çš„æŒ‡é’ˆï¼›<br/>
è€Œ idï¼ˆä»»æ„å¯¹è±¡ï¼‰ æ˜¯ä¸€ä¸ª objc_object ç»“æ„ç±»å‹çš„æŒ‡é’ˆï¼Œå…¶ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯ä¸€ä¸ª objc_class ç»“æ„ç±»å‹çš„æŒ‡é’ˆã€‚æ³¨æ„è¿™é‡Œæœ‰ä¸€å…³é”®çš„å¼•ç”³è§£è¯»ï¼šå†…å­˜å¸ƒå±€ä»¥ä¸€ä¸ª objc_class æŒ‡é’ˆä¸ºå¼€å§‹çš„æ‰€æœ‰ä¸œä¸œéƒ½å¯ä»¥å½“åšä¸€ä¸ª object æ¥å¯¹å¾…ï¼ <br/>
é‚£ objc_class åˆæ˜¯æ€æ ·ä¸€ä¸ªç»“æ„ä½“å‘¢ï¼Ÿ</p>

<pre class="line-numbers"><code class="language-text">struct objc_class {
    struct objc_class* isa;
    struct objc_class* super_class;
    const char* name;
    long version;
    long info;
    long instance_size;
    struct objc_ivar_list* ivars;
    struct objc_method_list** methodLists;
    struct objc_cache* cache;
    struct objc_protocol_list* protocols;
};
</code></pre>

<p>objc_class ç»“æ„ä½“çš„å„æˆå‘˜ä»‹ç»å¦‚ä¸‹ï¼š</p>

<p>isaï¼šæ˜¯ä¸€ä¸ª objc_class ç±»å‹çš„æŒ‡é’ˆï¼Œçœ‹åˆ°è¿™é‡Œï¼Œæƒ³èµ·æˆ‘å‰é¢çš„å¼•ç”³è§£è¯»äº†æ²¡ï¼Ÿå†…å­˜å¸ƒå±€ä»¥ä¸€ä¸ª objc_class æŒ‡é’ˆä¸ºå¼€å§‹çš„æ‰€æœ‰ä¸œä¸œéƒ½å¯ä»¥å½“åšä¸€ä¸ª object æ¥å¯¹å¾…ï¼ è¿™å°±æ˜¯è¯´ objc_class æˆ–è€…è¯´ç±»å…¶å®ä¹Ÿå¯ä»¥å½“åšä¸€ä¸ª objc_object å¯¹è±¡æ¥å¯¹å¾…ï¼å¯¹è±¡æ˜¯å¯¹è±¡ï¼Œç±»ä¹Ÿæ˜¯å¯¹è±¡ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹æ··æ·†ï¼Ÿåˆ«æ€¥ï¼ŒObjCå‘æ˜ï¼ˆor é‡ç”¨ï¼‰äº†ä¸€ä¸ªæœ¯è¯­æ¥åŒºåˆ†è¿™ä¸¤ç§ä¸åŒçš„å¯¹è±¡ï¼šç±»å¯¹è±¡ï¼ˆclass objectï¼‰ä¸å®ä¾‹å¯¹è±¡ï¼ˆinstance objectï¼‰ã€‚OKï¼Œåç§°æ··æ·†çš„é—®é¢˜è§£å†³ï¼Œä¸‹é¢æˆ‘å°†ä½¿ç”¨è¿™ä¸¤ä¸ªæœ¯è¯­æ¥åŒºåˆ†ä¸åŒçš„å¯¹è±¡ï¼Œè€Œä½¿ç”¨â€œå¯¹è±¡â€è¿™ä¸€æœ¯è¯­æ¥æ³›æŒ‡æ‰€æœ‰çš„å¯¹è±¡ã€‚ObjCè¿˜å¯¹ç±»å¯¹è±¡ä¸å®ä¾‹å¯¹è±¡ä¸­çš„ isa æ‰€æŒ‡å‘çš„ç±»ç»“æ„ä½œäº†ä¸åŒçš„å‘½åï¼šç±»å¯¹è±¡ä¸­çš„ isa æŒ‡å‘ç±»ç»“æ„è¢«ç§°ä½œ metaclassï¼Œmetaclass å­˜å‚¨ç±»çš„staticç±»æˆå‘˜å˜é‡ä¸staticç±»æˆå‘˜æ–¹æ³•ï¼ˆ+å¼€å¤´çš„æ–¹æ³•ï¼‰ï¼›å®ä¾‹å¯¹è±¡ä¸­çš„ isa æŒ‡å‘ç±»ç»“æ„ç§°ä½œ classï¼ˆæ™®é€šçš„ï¼‰ï¼Œclass ç»“æ„å­˜å‚¨ç±»çš„æ™®é€šæˆå‘˜å˜é‡ä¸æ™®é€šæˆå‘˜æ–¹æ³•ï¼ˆ-å¼€å¤´çš„æ–¹æ³•ï¼‰ã€‚</p>

<p>super_classï¼šä¸€çœ‹å°±æ˜ç™½ï¼ŒæŒ‡å‘è¯¥ç±»çš„çˆ¶ç±»å‘—ï¼å¦‚æœè¯¥ç±»å·²ç»æ˜¯æœ€é¡¶å±‚çš„æ ¹ç±»ï¼ˆå¦‚ NSObject æˆ– NSProxyï¼‰ï¼Œé‚£ä¹ˆ super_class å°±ä¸º NULLã€‚</p>

<p>å¥½ï¼Œå…ˆä¸­æ–­ä¸€ä¸‹å…¶ä»–ç±»ç»“æ„æˆå‘˜çš„ä»‹ç»ï¼Œè®©æˆ‘ä»¬å˜æ¸…ä¸€ä¸‹åœ¨ç»§æ‰¿å±‚æ¬¡ä¸­ï¼Œå­ç±»ï¼Œçˆ¶ç±»ï¼Œæ ¹ç±»ï¼ˆè¿™äº›éƒ½æ˜¯æ™®é€š classï¼‰ä»¥åŠå…¶å¯¹åº”çš„ metaclass çš„ isa ä¸ super_class ä¹‹é—´å…³ç³»:</p>

<p>è§„åˆ™ä¸€ï¼šç±»çš„å®ä¾‹å¯¹è±¡çš„ isa æŒ‡å‘è¯¥ç±»ï¼›è¯¥ç±»çš„ isa æŒ‡å‘è¯¥ç±»çš„ metaclassï¼›<br/>
è§„åˆ™äºŒï¼šç±»çš„ super_class æŒ‡å‘å…¶çˆ¶ç±»ï¼Œå¦‚æœè¯¥ç±»ä¸ºæ ¹ç±»åˆ™å€¼ä¸º NULLï¼›<br/>
è§„åˆ™ä¸‰ï¼šmetaclass çš„ isa æŒ‡å‘æ ¹ metaclassï¼Œå¦‚æœè¯¥ metaclass æ˜¯æ ¹ metaclass åˆ™æŒ‡å‘è‡ªèº«ï¼›<br/>
è§„åˆ™å››ï¼šmetaclass çš„ super_class æŒ‡å‘çˆ¶ metaclassï¼Œå¦‚æœè¯¥ metaclass æ˜¯æ ¹ metaclass åˆ™æŒ‡å‘è¯¥ metaclass å¯¹åº”çš„ç±»ï¼›</p>

<p>å¥½å§ï¼Œæ–‡å­—æ€»æ˜¯é‚£ä¹ˆä¹åŠ›ï¼Œæœ‰å›¾æœ‰çœŸç›¸ï¼<br/>
<img src="media/15786431485871/15786497073771.jpg" alt="" style="width:601px;"/></p>

<p>é‚£ä¹ˆ class ä¸ metaclass æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p>

<p>class æ˜¯ instance object çš„ç±»ç±»å‹ã€‚å½“æˆ‘ä»¬å‘å®ä¾‹å¯¹è±¡å‘é€æ¶ˆæ¯ï¼ˆå®ä¾‹æ–¹æ³•ï¼‰æ—¶ï¼Œæˆ‘ä»¬åœ¨è¯¥å®ä¾‹å¯¹è±¡çš„ class ç»“æ„çš„ methodlists ä¸­å»æŸ¥æ‰¾å“åº”çš„å‡½æ•°ï¼Œå¦‚æœæ²¡æ‰¾åˆ°åŒ¹é…çš„å“åº”å‡½æ•°åˆ™åœ¨è¯¥ class çš„çˆ¶ç±»ä¸­çš„ methodlists å»æŸ¥æ‰¾ï¼ˆæŸ¥æ‰¾é“¾ä¸ºä¸Šå›¾çš„ä¸­é—´é‚£ä¸€æ’ï¼‰ã€‚å¦‚ä¸‹é¢çš„ä»£ç ä¸­ï¼Œå‘str å®ä¾‹å¯¹è±¡å‘é€ lowercaseString æ¶ˆæ¯ï¼Œä¼šåœ¨ NSString ç±»ç»“æ„çš„ methodlists ä¸­å»æŸ¥æ‰¾ lowercaseString çš„å“åº”å‡½æ•°ã€‚</p>

<p>metaclass æ˜¯ class object çš„ç±»ç±»å‹ã€‚å½“æˆ‘ä»¬å‘ç±»å¯¹è±¡å‘é€æ¶ˆæ¯ï¼ˆç±»æ–¹æ³•ï¼‰æ—¶ï¼Œæˆ‘ä»¬åœ¨è¯¥ç±»å¯¹è±¡çš„ metaclass ç»“æ„çš„ methodlists ä¸­å»æŸ¥æ‰¾å“åº”çš„å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å“åº”å‡½æ•°åˆ™åœ¨è¯¥ metaclass çš„çˆ¶ç±»ä¸­çš„ methodlists å»æŸ¥æ‰¾ï¼ˆæŸ¥æ‰¾é“¾ä¸ºä¸Šå›¾çš„æœ€å³è¾¹é‚£ä¸€æ’ï¼‰ã€‚å¦‚ä¸‹é¢çš„ä»£ç ä¸­ï¼Œå‘ NSString ç±»å¯¹è±¡å‘é€ stringWithString æ¶ˆæ¯ï¼Œä¼šåœ¨ NSString çš„ metaclass ç±»ç»“æ„çš„ methodlists ä¸­å»æŸ¥æ‰¾ stringWithString çš„å“åº”å‡½æ•°ã€‚</p>

<hr/>

<p>å‚è€ƒï¼š<br/>
<a href="https://www.jianshu.com/p/829864680648">https://www.jianshu.com/p/829864680648</a><br/>
<a href="https://xiaozhuanlan.com/topic/0892715634">https://xiaozhuanlan.com/topic/0892715634</a><br/>
<a href="https://tech.glowing.com/cn/implement-kvo/">https://tech.glowing.com/cn/implement-kvo/</a><br/>
<a href="https://juejin.im/post/5aeff463f265da0b851cc6ac">https://juejin.im/post/5aeff463f265da0b851cc6ac</a><br/>
<a href="https://blog.csdn.net/Zsk_Zane/article/details/48194975">https://blog.csdn.net/Zsk_Zane/article/details/48194975</a><br/>
<a href="https://juejin.im/post/5aef18b76fb9a07aa34a28e6">https://juejin.im/post/5aef18b76fb9a07aa34a28e6</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/01/10</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15784529401988.html">
                
                  <h1>Label å¤šè¡Œæ¢è¡Œæœ€åä¸€è¡Œç°åœ¨æ›´è¿‡æŒ‰é’®</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p><img src="media/15784529401988/15784530763900.jpg" alt="" style="width:574px;"/><br/>
è¿™ç§å¤šè¡Œä¹‹åï¼ˆæœ€å¤šæ˜¾ç¤ºå‡ è¡Œï¼‰ï¼Œæœ€åä¸€è¡Œè¿˜æ˜¾ç¤ºä¸ä¸‹çš„æ—¶å€™ï¼Œè¦æ±‚æœ‰æ›´å¤šæŒ‰é’®ï¼ˆæˆ–è€…å…¨æ–‡ï¼‰è¿™ç§éœ€æ±‚å¾ˆå¸¸è§ã€‚å®ç°æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç»“åˆ NSAttributeSring å’Œ YYLabel å°±èƒ½å¾ˆç®€å•çš„å®ç°ã€‚å¦‚æœæœ€åçš„â€œæ›´å¤šâ€æˆ–è€…â€œå…¨æ–‡â€æŒ‰é’®è¦æ±‚è‡ªæé¢œè‰²æˆ–è€…å¤§å°ä¸ä¸€æ ·ï¼Œå•ç‹¬å¤„ç†è¿™ä¸ªæ ·å¼å³å¯</p>

<pre class="line-numbers"><code class="language-text">- (void)addSeeMoreButton {
    
    NSMutableAttributedString *text = [[NSMutableAttributedString alloc] initWithString:@&quot;   ... å…¨æ–‡&quot;];
    //æ·»åŠ æ–‡å­—é¢œè‰²
    [text addAttribute:NSForegroundColorAttributeName value:kColor_black1 range:NSMakeRange(text.length-2, 2)];
    [text addAttribute:NSForegroundColorAttributeName value:kColor_black2 range:NSMakeRange(0, text.length-2)];
    
    
    YYLabel *seeMore = [YYLabel new];
    seeMore.attributedText = text;
    [seeMore sizeToFit];
    NSMutableAttributedString *truncationToken = [NSMutableAttributedString attachmentStringWithContent:seeMore contentMode:UIViewContentModeCenter attachmentSize:seeMore.frame.size alignToFont:[UIFont systemFontOfSize:14] alignment:YYTextVerticalAlignmentCenter];
    self.passageContentLabel.truncationToken = truncationToken;
}

</code></pre>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/01/08</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E5%BC%80%E5%8F%91%E6%8A%80%E5%B7%A7%E6%95%B4%E7%90%86.html'>iOS å¼€å‘æŠ€å·§æ•´ç†</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15780315733102.html">
                
                  <h1>æ¢å¯» OC å¯¹è±¡çš„æœ¬è´¨</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<blockquote>
<p>é¢è¯•é¢˜ï¼šä¸€ä¸ª NSObject å¯¹è±¡å ç”¨å¤šå°‘å†…å­˜ï¼Ÿ</p>
</blockquote>

<p>æˆ‘ä»¬å¹³æ—¶ç¼–å†™çš„ä»£ç éƒ½æ˜¯ Objective-C çš„ä»£ç ï¼Œä½†æ˜¯åº•å±‚å®ç°å…¶å®éƒ½æ˜¯ C/C++çš„ä»£ç </p>

<pre class="line-numbers"><code class="language-text">#import &lt;Foundation/Foundation.h&gt;
#import &lt;malloc/malloc.h&gt;
#import &lt;objc/runtime.h&gt;

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSObject *obj = [[NSObject alloc] init];
        // åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå®é™…ä¸Šåˆ†é…å¤šå°‘å†…å­˜ - 16
        NSLog(@&quot;%zd&quot;, malloc_size((__bridge const void *)obj));

        // åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œè‡³å°‘éœ€è¦å¤šå°‘å†…å­˜ - 8
        NSLog(@&quot;%zd&quot;, class_getInstanceSize([NSObject class]));
    }
    return 0;
}
</code></pre>

<ul>
<li>ç³»ç»Ÿåˆ†é…äº† 16 ä¸ªå­—èŠ‚ç»™ NSObject å¯¹è±¡ï¼ˆé€šè¿‡ mallocâ€”â€”size å‡½æ•°è·å¾—ï¼‰</li>
<li><p>OC æºç æ˜¾ç¤ºåˆ†é…ç»™å¯¹è±¡çš„å†…å­˜ä¸º 16 ä¸ªå­—èŠ‚çš„æ•´æ•°å€ï¼Œè‡³å°‘æ˜¯ 16 ä¸ªå­—èŠ‚</p>
<p><img src="media/15780315733102/15780350303674.jpg" alt="" style="width:660px;"/></p></li>
</ul>

<blockquote>
<p>OCçš„å¯¹è±¡ã€ç±»ä¸»è¦æ˜¯åŸºäºC\C++çš„ä»€ä¹ˆæ•°æ®ç»“æ„å®ç°çš„å‘¢ï¼Ÿ<br/>
ç»“æ„ä½“<br/>
OC çš„å¯¹è±¡æ˜¯åŸºäº C çš„ç»“æ„ä½“å®ç°çš„<br/>
è¿™ä¸ªç»“æ„ä½“åªæœ‰ä¸€ä¸ªæˆå‘˜ï¼šisa æŒ‡é’ˆï¼Œè€ŒæŒ‡é’ˆåœ¨ 64 ä½æ¶æ„ä¸­å  8 ä¸ªå­—èŠ‚ã€‚<br/>
é‚£ä¹ˆè¿™ä¸ªç»“æ„ä½“å å¤šå¤§çš„å†…å­˜ç©ºé—´å‘¢ï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸ªç»“æ„ä½“åªæœ‰ä¸€ä¸ªæˆå‘˜ï¼ŒisaæŒ‡é’ˆï¼Œè€ŒæŒ‡é’ˆåœ¨64ä½æ¶æ„ä¸­å 8ä¸ªå­—èŠ‚ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªNSObjecå¯¹è±¡æ‰€å ç”¨çš„å†…å­˜æ˜¯8ä¸ªå­—èŠ‚ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»å¯ä»¥åŸºæœ¬è§£ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°NSObjectå¯¹è±¡ä¸­è¿˜æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œé‚£è¿™äº›æ–¹æ³•ä¸å ç”¨å†…å­˜ç©ºé—´å—ï¼Ÿå…¶å®ç±»çš„æ–¹æ³•ç­‰ä¹Ÿå ç”¨å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯è¿™äº›æ–¹æ³•æ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´å¹¶ä¸åœ¨NSObjectå¯¹è±¡ä¸­ã€‚</p>
</blockquote>

<h2 id="toc_0">å®ä¾‹å¯¹è±¡ ç±»ï¼ˆå¯¹è±¡ï¼‰ å…ƒç±»</h2>

<p><img src="media/15780315733102/15780363563241.jpg" alt="" style="width:552px;"/></p>

<blockquote>
<ol>
<li>instanceçš„isaæŒ‡å‘class</li>
<li>classçš„isaæŒ‡å‘meta-class</li>
<li>meta-classçš„isaæŒ‡å‘åŸºç±»çš„meta-classï¼ŒåŸºç±»çš„isaæŒ‡å‘è‡ªå·±</li>
<li>classçš„superclassæŒ‡å‘çˆ¶ç±»çš„classï¼Œå¦‚æœæ²¡æœ‰çˆ¶ç±»ï¼ŒsuperclassæŒ‡é’ˆä¸ºnil</li>
<li>meta-classçš„superclassæŒ‡å‘çˆ¶ç±»çš„meta-classï¼ŒåŸºç±»çš„meta-classçš„superclassæŒ‡å‘åŸºç±»çš„class</li>
<li>instanceè°ƒç”¨å¯¹è±¡æ–¹æ³•çš„è½¨è¿¹ï¼Œisaæ‰¾åˆ°classï¼Œæ–¹æ³•ä¸å­˜åœ¨ï¼Œå°±é€šè¿‡superclassæ‰¾çˆ¶ç±»</li>
<li>classè°ƒç”¨ç±»æ–¹æ³•çš„è½¨è¿¹ï¼Œisaæ‰¾meta-classï¼Œæ–¹æ³•ä¸å­˜åœ¨ï¼Œå°±é€šè¿‡superclassæ‰¾çˆ¶ç±»</li>
</ol>
</blockquote>

<h2 id="toc_1">ä¸ºä»€ä¹ˆä¼šå­˜åœ¨å…ƒç±»ï¼Ÿ</h2>

<p>å…ƒç±»æ˜¯ä¸€ä¸ªç±»å¯¹è±¡çš„ç±»<br/>
ç®€è€Œè¨€ä¹‹ï¼š<br/>
å½“ä½ å‘ä¸€ä¸ªå¯¹è±¡å‘é€ä¸€æ¡æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿è¡Œæ—¶ä¼šåœ¨å¯¹è±¡çš„ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾è¿™æ¡æ¶ˆæ¯æ˜¯å¦å­˜åœ¨ã€‚<br/>
å½“ä½ å‘ä¸€ä¸ªç±»å‘é€ä¸€æ¡æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿è¡Œæ—¶ä¼šåœ¨ç±»çš„å…ƒç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾è¿™æ¡æ¶ˆæ¯æ˜¯å¦å­˜åœ¨ã€‚</p>

<p>å…ƒç±»çš„å­˜åœ¨æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºä»–å­˜å‚¨äº†ä¸€ä¸ªç±»çš„æ‰€æœ‰ç±»æ–¹æ³•ã€‚æ¯ä¸ªç±»çš„å…ƒç±»éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œå› ä¸ºæ¯ä¸ªç±»éƒ½æœ‰ä¸€ç³»åˆ—ç‹¬ç‰¹çš„ç±»æ–¹æ³•ã€‚<br/>
ä»€ä¹ˆæ˜¯å…ƒç±»çš„ç±»</p>

<p>å…ƒç±»ï¼Œå’Œç±»ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚è¿™è¡¨ç¤ºä½ èƒ½å¤Ÿå¯¹å…ƒç±»è°ƒç”¨æ–¹æ³•ã€‚è‡ªç„¶çš„ï¼Œè¿™è¡¨ç¤ºä»–å¿…é¡»ä¹Ÿæœ‰ä¸€ä¸ªç±»æŒ‡é’ˆã€‚</p>

<p>æ‰€æœ‰å…ƒç±»ä½¿ç”¨åŸºç±»çš„å…ƒç±»ï¼ˆå³ç»§æ‰¿é“¾é¡¶ç«¯çš„ç±»çš„å…ƒç±»ï¼‰ä½œä¸ºä»–ä»¬çš„ç±»ï¼Œè€Œæ‰€æœ‰ç±»çš„åŸºç±»éƒ½æ˜¯ NSObjectï¼ˆå¤§å¤šæ•°ç±»æ˜¯è¿™æ ·çš„ï¼‰ï¼Œæ‰€ä»¥å¤§å¤šæ•°å…ƒç±»ä½¿ç”¨ NSObject çš„å…ƒç±»ä½œä¸ºä»–çš„ç±»ã€‚</p>

<p>æ ¹æ®è§„åˆ™æ‰€æœ‰å…ƒç±»ä½¿ç”¨åŸºç±»çš„å…ƒç±»ä½œä¸ºä»–ä»¬çš„ç±»ï¼Œé‚£ä¹ˆåŸºç±»çš„å…ƒç±»å°±æ˜¯ä»–è‡ªå·±çš„ç±»ï¼ˆä»–ä»¬çš„isaæŒ‡é’ˆæŒ‡å‘äº†è‡ªå·±ï¼‰ã€‚è¿™è¡¨æ˜NSObjectçš„å…ƒç±»çš„æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä»–è‡ªå·±ï¼ˆä»–æ˜¯ä¸€ä¸ªä»–è‡ªå·±çš„å®ä¾‹ï¼‰ã€‚</p>

<h2 id="toc_2">ç»§æ‰¿ç±»å’Œå…ƒç±»</h2>

<p>åŒæ ·çš„ï¼Œç±»ä½¿ç”¨ super_class æŒ‡é’ˆæŒ‡å‘ä»–ä»¬çš„ superclassï¼Œå…ƒç±»ä¹Ÿæœ‰ super_class æŒ‡é’ˆæ¥æŒ‡å‘ superclassã€‚<br/>
è¿™é‡Œåˆæœ‰ä¸€ä¸ªå¥‡æ€ªçš„åœ°æ–¹ï¼ŒåŸºç±»çš„å…ƒç±»è®¾ç½®çš„ superclass æ˜¯åŸºç±»è‡ªå·±ã€‚<br/>
è¿™ç§ç»§æ‰¿ç»“æ„å¯¼è‡´çš„ç»“æœæ˜¯æ‰€æœ‰ç»“æ„ä¸­çš„å®ä¾‹ã€ç±»ä»¥åŠå…ƒç±»éƒ½ç»§æ‰¿è‡ªç»“æ„ä¸­çš„åŸºç±»ã€‚</p>

<p>æ‰€æœ‰å®ä¾‹ã€ç±»å’Œå…ƒç±»éƒ½åœ¨ NSObject çš„å±‚çº§ä¸‹ï¼Œè¿™è¡¨æ˜æ‰€æœ‰ NSObject çš„å®ä¾‹æ–¹æ³•éƒ½èƒ½å¤Ÿè¢«ä½¿ç”¨ï¼ŒåŒæ ·çš„ï¼Œå¯¹ç±»ä»¥åŠå…ƒç±»æ¥è¯´ï¼Œæ‰€æœ‰ NSObject çš„ç±»æ–¹æ³•ä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚</p>

<h2 id="toc_3">å…ƒç±»æ€»ç»“ï¼š</h2>

<p>å…ƒç±»æ˜¯ä¸€ä¸ªç±»å¯¹è±¡çš„ç±»ã€‚æ¯ä¸€ä¸ªç±»æœ‰ä»–è‡ªå·±ç‹¬ä¸€æ— äºŒçš„å…ƒç±»ï¼ˆå› ä¸ºæ¯ä¸ªç±»èƒ½å¤Ÿæœ‰è‡ªå·±ç‹¬ä¸€æ— äºŒçš„æ–¹æ³•åˆ—è¡¨ï¼‰ã€‚è¿™å°±æ„å‘³ç€ç±»å¯¹è±¡çš„ç±»å¹¶ä¸æ˜¯å’Œä»–ä»¬ä¸€æ ·çš„ç±»ã€‚</p>

<p>å…ƒç±»èƒ½ç¡®ä¿ç±»å¯¹è±¡æœ‰æ‰€æœ‰åº•å±‚ç±»çš„å®ä¾‹å’Œç±»æ–¹æ³•ï¼Œä¸­é—´åŠ ä¸Šæ‰€æœ‰è‡ªå·±çš„ç±»æ–¹æ³•ã€‚æ‰€æœ‰ç±»ç»§æ‰¿è‡ªNSObjectï¼Œè¿™æ„å‘³ç€NSObjectæ‰€æœ‰çš„å®ä¾‹å’Œåè®®æ–¹æ³•ä¸ºæ‰€æœ‰ç±»ï¼ˆå’Œå…ƒç±»ï¼‰å¯¹è±¡éƒ½å®šä¹‰äº†ã€‚</p>

<p>æ‰€æœ‰å…ƒç±»ä½¿ç”¨åŸºç±»çš„å…ƒç±»ï¼ˆNSObject å…ƒç±»ï¼‰æ¥ä½œä¸ºä»–ä»¬çš„ç±»ï¼ŒåŒ…æ‹¬åªåœ¨è¿è¡Œæ—¶è‡ªå®šä¹‰çš„ç±»çš„å…ƒç±»ã€‚</p>

<p>å‚è€ƒï¼š<br/>
<a href="https://juejin.im/post/5ac81c75518825556534c0af">https://juejin.im/post/5ac81c75518825556534c0af</a><br/>
<a href="https://www.jianshu.com/p/79b06fabb459">https://www.jianshu.com/p/79b06fabb459</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/01/03</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="shu-xing-de-shi-zhi-shu-xing-d.html">
                
                  <h1>å±æ€§çš„å®è´¨</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<blockquote>
<p>å±æ€§çš„å®è´¨æ˜¯ä»€ä¹ˆï¼Ÿ<br/>
åŒ…æ‹¬å“ªå‡ ä¸ªéƒ¨åˆ†ï¼Ÿ<br/>
å±æ€§é»˜è®¤çš„å…³é”®å­—éƒ½æœ‰å“ªäº›ï¼Ÿ<br/>
@dynamicå…³é”®å­—å’Œ@synthesizeå…³é”®å­—æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„</p>
</blockquote>

<p>å®è´¨åŒ…å«éƒ¨åˆ†:</p>

<p>@property = ivar + getter + setter;</p>

<p>å®ä¾‹å˜é‡+getæ–¹æ³•+ setæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨@propertyç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆsetterå’Œgetteræ–¹æ³•;</p>

<p>é»˜è®¤å¸¸ç”¨å…³é”®å­—:</p>

<p>propertyä¸­æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„å…³é”®å­—æœ‰strongï¼Œweakï¼Œassignï¼Œcopyï¼Œnonatomicï¼Œatomic....ç­‰</p>

<p>@dynamicè¿™ä¸ªå…³é”®è¯ï¼Œé€šå¸¸æ˜¯ç”¨ä¸åˆ°çš„ã€‚<br/>
å®ƒä¸@synthesizeçš„åŒºåˆ«åœ¨äºï¼š<br/>
ä½¿ç”¨@synthesizeç¼–è¯‘å™¨ä¼šç¡®å®çš„äº§ç”Ÿgetterå’Œsetteræ–¹æ³•ï¼Œè€Œ@dynamicä»…ä»…æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨è¿™ä¸¤ä¸ªæ–¹æ³•åœ¨è¿è¡ŒæœŸä¼šæœ‰çš„ï¼Œæ— éœ€äº§ç”Ÿè­¦å‘Šã€‚</p>

<p>å‡è®¾æœ‰è¿™ä¹ˆä¸ªåœºæ™¯ï¼ŒBç±»ï¼ŒCç±»åˆ†åˆ«ç»§æ‰¿Aç±»ï¼ŒAç±»å®ç°æŸä¸ªåè®®ï¼ˆ@protocolï¼‰ï¼Œåè®®ä¸­æŸä¸ªå±æ€§( somePropety )æˆ‘ä¸æƒ³åœ¨Aä¸­å®ç°ï¼Œè€Œåœ¨Bç±»ï¼ŒCç±»ä¸­åˆ†åˆ«å®ç°ã€‚å¦‚æœAä¸­ä¸å†™ä»»ä½•ä»£ç ï¼Œç¼–è¯‘å™¨å°±ä¼šç»™å‡ºè­¦å‘Šï¼šâ€œuse @synthesize, @dynamic or provide a method implementation&quot;è¿™æ—¶ä½ ç»™ç”¨@dynamic somePropety; <br/>
ç¼–è¯‘å™¨å°±ä¸ä¼šè­¦å‘Šï¼ŒåŒæ—¶ä¹Ÿä¸ä¼šäº§ç”Ÿä»»ä½•é»˜è®¤ä»£ç ã€‚</p>

<p>@dynamic å°±æ˜¯è¦æ¥å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œä»£ç ä¸­ç”¨@dynamicä¿®é¥°çš„å±æ€§ï¼Œå…¶getterå’Œsetteræ–¹æ³•ä¼šåœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™æˆ–è€…ç”¨å…¶ä»–æ–¹å¼åŠ¨æ€ç»‘å®šï¼Œä»¥ä¾¿è®©ç¼–è¯‘å™¨é€šè¿‡ç¼–è¯‘ã€‚<br/>
å…¶ä¸»è¦çš„ä½œç”¨å°±æ˜¯ç”¨åœ¨NSManageObjectå¯¹è±¡çš„å±æ€§å£°æ˜ä¸Šï¼Œç”±äºæ­¤ç±»å¯¹è±¡çš„å±æ€§ä¸€èˆ¬æ˜¯ä»Core Dataçš„å±æ€§ä¸­ç”Ÿæˆçš„ï¼ŒCore Dataæ¡†æ¶ä¼šåœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™ä¸ºæ­¤ç±»å±æ€§ç”Ÿæˆgetterå’ŒSetteræ–¹æ³•ã€‚</p>

<p>å‚è€ƒ:</p>

<p><a href="">https://www.jianshu.com/p/00dbeec23291</a></p>

<hr/>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/01/03</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="15780200209710.html">
                
                  <h1>iOS å“åº”è€…é“¾åŠäº‹ä»¶ä¼ é€’</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<h2 id="toc_0">UIResponder</h2>

<p>åœ¨ iOSä¸­ï¼Œæ‰€æœ‰å“åº”äº‹ä»¶å¤„ç†äº‹ä»¶çš„å¯¹è±¡éƒ½ç›´æ¥æˆ–é—´æ¥çš„ç»§æ‰¿UIResponderã€‚<br/>
åœ¨ iOS è§†å›¾ç»“æ„ä¸­ï¼Œå‘ˆç°å‡ºæ¥çš„æ˜¯ä¸€ä¸ª N å‰æ ‘çš„æ ‘å½¢ç»“æ„ï¼Œæ¯ä¸ªè§†å›¾éƒ½åªæœ‰ä¸€ä¸ªçˆ¶è§†å›¾ï¼Œå¯ä»¥æœ‰å¤šä¸ªå­è§†å›¾ã€‚<br/>
<img src="https://tva1.sinaimg.cn/large/006tNbRwgy1g9lpldkdtyj30he0go46i.jpg" alt=""/></p>

<h2 id="toc_1">å¯»æ‰¾ç¬¬ä¸€å“åº”è€…</h2>

<p>å½“ç”¨æˆ·ç‚¹å‡»æŸä¸ªè§†å›¾æˆ–è€…æŒ‰é’®çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆå“åº” applocation ä¸­çš„ UIWindow ä¸€å±‚ä¸€å±‚çš„å‘ä¸‹æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç‚¹å‡»çš„ viewï¼Œè¿™é˜¶æ®µç”¨åˆ°çš„ä¸¤ä¸ªæ–¹æ³•ï¼š</p>

<pre class="line-numbers"><code class="language-text">- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event;   // recursively calls -pointInside:withEvent:. point is in the receiver&#39;s coordinate system
- (BOOL)pointInside:(CGPoint)point withEvent:(UIEvent *)event;   // default returns YES if point is in bounds
</code></pre>

<p>ä¾‹å¦‚æœ‰è¿™æ ·ä¸€ä¸ªå›¾å±‚ç»“æ„ï¼š<br/>
<img src="https://tva1.sinaimg.cn/large/006tNbRwgy1g9lpsaqbekj30e80jamy9.jpg" alt=""/></p>

<p>åœ¨ä¸Šå›¾ä¸­ç”¨æˆ·ç‚¹å‡»è§†å›¾ä¸­çš„ViewDæ—¶ï¼ŒUIWindowé¦–å…ˆæ¥æ”¶åˆ°å“åº”ï¼Œæ­¤å“åº”åŒ…æ‹¬ç”¨æˆ·ç‚¹å‡»çš„åŒºåŸŸå’Œä¸€ä¸ªå°è£…å¥½çš„UIEventå¯¹è±¡ï¼Œç„¶åUIWindowé€šè¿‡è¿™äº›ä¿¡æ¯åˆ©ç”¨ä»¥ä¸‹æ–¹æ³•æŸ¥æ‰¾ï¼š</p>

<ol>
<li><p>UIWindowä¼šé€šè¿‡è°ƒç”¨pointInside:withEvent:æ–¹æ³•è¿”å›çš„YESå¾—çŸ¥ç”¨æˆ·ç‚¹å‡»çš„èŒƒå›´åœ¨ViewAä¸­ï¼›</p></li>
<li><p>ViewAè°ƒç”¨hitTest:withEvent:æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­éå†æ‰€æœ‰çš„subView(ViewBã€ViewC)è°ƒç”¨hitTest:withEvent:æ–¹æ³•ï¼›</p></li>
<li><p>åœ¨éå†ä¸­å‘ç°ä½¿ç”¨ViewCè°ƒç”¨pointInside:withEvent:æ–¹æ³•æ—¶è¿”å›YESï¼Œå¾—çŸ¥ç”¨æˆ·ç‚¹å‡»åœ¨ViewCèŒƒå›´ä¹‹å†…ï¼›</p></li>
<li><p>ViewCè°ƒç”¨hitTest:withEvent:æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­éå†æ‰€æœ‰çš„subView(ViewDã€ViewE)è°ƒç”¨hitTest:withEvent:æ–¹æ³•;</p></li>
<li><p>åœ¨éå†ä¸­å‘ç°ä½¿ç”¨ViewDè°ƒç”¨pointInside:withEvent:æ–¹æ³•æ—¶è¿”å›YESï¼Œå¾—çŸ¥ç”¨æˆ·ç‚¹å‡»åœ¨ViewDèŒƒå›´ä¹‹å†…;</p></li>
<li><p>åœ¨ViewDè°ƒç”¨hitTest:withEvent:æ–¹æ³•ä¹‹å‰å‘ç°Viewçš„subViewsçš„countä¸º0ï¼Œæ•…ç¡®å®šç”¨æˆ·ç‚¹å‡»åœ¨ViewDä¹‹ä¸Šã€‚</p></li>
</ol>

<p>UIWindowä¼šç”¨éå†subviewsï¼Œä½¿ç”¨æ¯ä¸€ä¸ªsubviewè°ƒç”¨hitTest:withEvent:æ–¹æ³•ï¼Œå¦‚æœç”¨æˆ·ç‚¹å‡»åœ¨æŸä¸€ä¸ªsubviewä¸Šï¼ŒpointInside:withEvent:æ–¹æ³•è¿”å›YESï¼Œå†ç”¨è¿™ä¸ªsubviewè°ƒç”¨hitTest:withEvent:æ–¹æ³•ï¼Œä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°å½“å‰viewæ²¡æœ‰å­viewæˆ–ç‚¹å‡»çš„ä½ç½®æ²¡æœ‰åœ¨å…¶ä»»ä½•å­viewä¹‹ä¸Šï¼Œä¾¿ç¡®å®šç”¨æˆ·ç‚¹å‡»åœ¨æŸviewä¸Š</p>

<pre class="line-numbers"><code class="language-text">- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event{
    for (UIView *view in self.subviews) {
        if([view pointInside:point withEvent:event]){
            UIView *hitTestView = [view hitTest:point withEvent:event];
            if(nil == hitTestView){
                return view;
            }
        }
    }
    return nil;
}
</code></pre>

<blockquote>
<p>1.Alpha=0ã€å­è§†å›¾è¶…å‡ºçˆ¶è§†å›¾çš„æƒ…å†µã€userInteractionEnabled=NOã€hidden=YESè§†å›¾ä¼šè¢«å¿½ç•¥ï¼Œä¸ä¼šè°ƒç”¨hitTest<br/>
2.çˆ¶è§†å›¾è¢«å¿½ç•¥åå…¶æ‰€æœ‰å­è§†å›¾ä¹Ÿä¼šè¢«å¿½ç•¥<br/>
3.å‡ºç°è§†å›¾æ— æ³•å“åº”çš„æƒ…å†µï¼Œå¯ä»¥è€ƒè™‘ä¸Šè¯‰æƒ…å†µæ¥æ’æŸ¥é—®é¢˜</p>
</blockquote>

<h2 id="toc_2">äº‹ä»¶ä¼ é€’</h2>

<p>äº‹ä»¶ä¼ é€’çš„é¡ºåºå…¶å®å°±æ˜¯å¯»æ‰¾ç¬¬ä¸€å“åº”è€…çš„é€†åºï¼Œå½“æ‰¾åˆ°äº†ç¬¬ä¸€å“åº”ï¼ˆViewï¼Œbuttonï¼‰ä¹‹åï¼Œå“åº”è€…å°±è¦å¯¹äº‹ä»¶ä½œå‡ºå“åº”ï¼Œè¿™é‡Œå°±æ˜¯ä½¿ç”¨äº† UIResponder çš„ nextResponder æ–¹æ³•ã€‚</p>

<h3 id="toc_3">nextResponder çš„è§„åˆ™</h3>

<p>å› ä¸ºUIViewå’ŒUIViewControlleréƒ½æ˜¯ç»§æ‰¿äºUIResponderï¼Œæ‰€ä»¥åœ¨è°ƒç”¨nextResponderæ—¶æœ‰å‡ æ¡è§„åˆ™å¦‚ä¸‹ï¼š</p>

<ol>
<li><p>å½“ä¸€ä¸ªviewè°ƒç”¨å…¶nextResponderä¼šè¿”å›å…¶superView;</p></li>
<li><p>å¦‚æœå½“å‰çš„viewä¸ºUIViewControllerçš„viewè¢«æ·»åŠ åˆ°å…¶ä»–viewä¸Šï¼Œé‚£ä¹ˆè°ƒç”¨nextResponderä¼šè¿”å›å½“å‰çš„UIViewControllerï¼Œè€Œè¿™ä¸ªUIViewControllerçš„nextResponderä¸ºviewçš„superViewï¼›</p></li>
<li><p>å¦‚æœå½“å‰çš„UIViewControllerçš„viewæ²¡æœ‰æ·»åŠ åˆ°ä»»ä½•å…¶ä»–viewä¸Šï¼Œå½“å‰çš„UIViewControllerçš„nextResponderä¸ºnilï¼Œä¸ç®¡å®ƒæ˜¯keyWinodwæˆ–UINavigationControllerçš„rootViewControllerï¼Œéƒ½æ˜¯å¦‚æ­¤ï¼›</p></li>
<li><p>å¦‚æœå½“å‰applicationçš„keyWindowçš„rootViewControllerä¸ºUINavigationController(æˆ–UITabViewController)ï¼Œé‚£ä¹ˆé€šè¿‡è°ƒç”¨UINavigationController(æˆ–UITabViewController)çš„nextResponderå¾—åˆ°keyWinodwï¼›</p></li>
<li><p>keyWinodwçš„nextResponderä¸ºUIApplicationï¼ŒUIApplicationçš„nextResponderä¸ºAppDelegateï¼ŒAppDelegateçš„nextResponderä¸ºnilã€‚</p></li>
</ol>

<p>é€šè¿‡çŸ¥é“äº†ä¸Šè¿°è§„åˆ™ï¼Œä¾¿å¯ä»¥é€šè¿‡ç”¨æˆ·ç‚¹å‡»çš„ViewDï¼ŒæŸ¥çœ‹ViewDæ˜¯å¦å“åº”äº†ç‚¹å‡»äº‹ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾å®ƒçš„nextResponderï¼Œå¦‚æœæ²¡æœ‰å†ç»§ç»­æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°AppDelegateå†æ²¡æœ‰å“åº”ï¼Œåˆ™æ­¤ç‚¹å‡»äº‹ä»¶è¢«ç³»ç»Ÿä¸¢å¼ƒï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š<br/>
<img src="https://tva1.sinaimg.cn/large/006tNbRwgy1g9lu7zsmnqj30fa0f8adu.jpg" alt=""/><br/>
äº‹ä»¶å“åº”é“¾çš„å¤§è‡´æµç¨‹å°±æ˜¯å¦‚æ­¤äº†ï¼Œå¤§æ¦‚å°±æ˜¯ä¸€ä¸ªå…ˆå‘ä¸‹æ‰¾ï¼Œå†å‘ä¸Šæ‰¾çš„è¿‡ç¨‹ï¼</p>

<h2 id="toc_4">æ— æ³•å“åº”çš„æƒ…å†µ</h2>

<p>å‚è€ƒï¼š<br/>
<a href="">https://www.cnblogs.com/easy-coding/p/3604856.html</a></p>

<p><a href="">https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/using_responders_and_the_responder_chain_to_handle_events?language=objc</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/01/03</span>
                    <span>posted in&nbsp;</span> 
          				  
          					    <span class="posted-in"><a href='iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html'>iOS é¢è¯•å‡†å¤‡</a></span>
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
              


			<div class="row">
			  <div class="large-6 columns">
			  <p class="text-left" style="padding-top:25px;">
			   
			  </p>
			  </div>
			  <div class="large-6 columns">
			<p class="text-right" style="padding-top:25px;">
			
			</p>
			  </div>
			</div>
		</div>
	</div><!-- large 8 -->

 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <div class="site-a-logo"><img src="img/icon.jpg" /></div>
            
                <h1>å°é©¬åŒå­¦çš„ç¢ç¢å¿µ</h1>
                <div class="site-des">å°é©¬åŒå­¦çš„ç¢ç¢å¿µ</div>
                <div class="social">









<a target="_blank" class="github" target="_blank" href="https://github.com/macongLeo/macongLeo.github.io.git" title="GitHub">GitHub</a>

  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="iOS%20%E9%9D%A2%E8%AF%95%E5%87%86%E5%A4%87.html"><strong>iOS é¢è¯•å‡†å¤‡</strong></a>
        
            <a href="iOS%20%E5%BC%80%E5%8F%91%E6%8A%80%E5%B7%A7%E6%95%B4%E7%90%86.html"><strong>iOS å¼€å‘æŠ€å·§æ•´ç†</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15824490308760.html">å¯¹è±¡ä»åˆ›å»ºåˆ°é”€æ¯è¿‡ç¨‹çš„æ¢ç©¶</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15823522930291.html">å‡†å¤‡</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15821054226825.html">ç‰›é€¼çš„GCD</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15820370480952.html">ç±» å­ç±» åˆ†ç±» åŒºåˆ«ä¸è”ç³»</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15820364056941.html">å…³è”å¯¹è±¡ AssociatedObject å®Œå…¨è§£æ</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>



  














<style type="text/css">
figure{margin: 0;padding: 0;}
figcaption{text-align:center;}

/* PrismJS 1.14.0
 http://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
    color: black;
    background: none;
    text-shadow: 0 1px white;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
    
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
    
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
    text-shadow: none;
    background:#b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
    text-shadow: none;
    background: #b3d4fc;
}

@media print {
    code[class*="language-"],
    pre[class*="language-"] {
        text-shadow: none;
    }
}

/* Code blocks */
pre[class*="language-"] {
    padding: 1em;
    margin: .5em 0;
    overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
    background: #F7F7F7;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
    padding: .1em;
    border-radius: .3em;
    white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
    color: slategray;
}

.token.punctuation {
    color: #999;
}

.namespace {
    opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
    color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
    color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
    color: #9a6e3a;
    background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
    color: #07a;
}

.token.function,
.token.class-name {
    color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
    color: #e90;
}

.token.important,
.token.bold {
    font-weight: bold;
}
.token.italic {
    font-style: italic;
}

.token.entity {
    cursor: help;
}


pre[class*="language-"].line-numbers {
    position: relative;
    padding-left: 3.8em;
    counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
    position: relative;
    white-space: inherit;
}

.line-numbers .line-numbers-rows {
    position: absolute;
    pointer-events: none;
    top: 0;
    font-size: 100%;
    left: -3.8em;
    width: 3em; /* works for line-numbers below 1000 lines */
    letter-spacing: -1px;
    border-right: 1px solid #999;

    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;

}

    .line-numbers-rows > span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }

        .line-numbers-rows > span:before {
            content: counter(linenumber);
            color: #999;
            display: block;
            padding-right: 0.8em;
            text-align: right;
        }

</style>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>



  </body>
</html>
